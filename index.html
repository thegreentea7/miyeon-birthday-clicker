<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Miyeon Birthday Clicker</title>
  <style>

:root{
      --bgA:#06150B;
      --bgB:#0A2B17;

      --green:#3DFF8B;
      --green2:#A8FFCC;

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);

      --stroke: rgba(255,255,255,.12);
      --card: rgba(255,255,255,.06);

      --shadow: 0 22px 70px rgba(0,0,0,.45);
      --radius: 18px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }

    .hidden{ display:none !important; }
    html,body{ height:100%; overflow:hidden; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 850px at 15% 15%, rgba(61,255,139,.14), transparent 60%),
        radial-gradient(900px 700px at 85% 25%, rgba(168,255,204,.10), transparent 55%),
        linear-gradient(160deg, var(--bgA), var(--bgB));
      overflow:hidden;
    }

     .page{
      width:100vw;
      height:100vh;
      display:grid;
      grid-template-rows: auto 1fr;
      gap:12px;
      padding:14px;
    }

    .topbar{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 240px;
    }
    .logo{
      width:42px; height:42px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(18px 18px at 25% 25%, rgba(255,255,255,.75), transparent 70%),
        radial-gradient(26px 26px at 75% 75%, rgba(61,255,139,.18), transparent 70%),
        linear-gradient(180deg, rgba(61,255,139,.20), rgba(255,255,255,.04));
      display:grid;
      place-items:center;
      font-size:18px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.12);
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      line-height:1.12;
    }
    .title b{ font-size:15.5px; letter-spacing:.2px; }
    .title span{ font-size:12.5px; color: var(--muted); }

    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      font-size:12.5px;
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .pill .k{ color: var(--muted); }
    .pill .v{
      font-weight:950;
      font-family: var(--mono);
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum" 1, "lnum" 1;
      display:inline-block;
      min-width: 6.2ch;
      text-align:right;
    }

    .main{
      width:100%;
      display:grid;
      grid-template-columns: minmax(320px, 360px) 1fr minmax(300px, 360px);
      gap:12px;
      min-height: 0;
      align-items: stretch;
    }
    @media (max-width: 980px){
      .main{
        grid-template-columns: 1fr;
      }
    }

    .panel{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
      position:relative;
      min-height: 0;
    }
    
    .play{
      position:relative;
      display:flex;
      flex-direction:column;
      min-height: 640px;
    }

    .playHeader{
      padding:14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 160px at 50% 0%, rgba(61,255,139,.10), transparent 60%),
        rgba(0,0,0,.18);
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }

    .bigStat{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .bigStat .h{
      font-weight:950;
      letter-spacing:.2px;
      opacity:.92;
    }
    .bigStat .num{
      font-weight:950;
      font-size:34px;
      line-height:1;
      text-shadow: 0 12px 30px rgba(0,0,0,.35);
      font-family: var(--mono);
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum" 1, "lnum" 1;
    }
    .bigStat .sub{
      color: var(--muted);
      font-size:12.5px;
    }

    .playBody{
      position:relative;
      flex:1 1 auto;
      min-height:0;
      overflow:hidden;
      background:
        radial-gradient(900px 600px at 50% 45%, rgba(61,255,139,.12), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.18));
    }

    .heartsLayer{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:1;
    }
    .fallHeart{
      position:absolute;
      top:-40px;
      font-size: 22px;
      opacity:.75;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
      animation: fall linear forwards;
    }
    @keyframes fall{
      to{
        transform: translateY(calc(100vh + 120px)) rotate(160deg);
        opacity:.0;
      }
    }

    .glow{
      position:absolute;
      left:50%;
      top:52%;
      transform: translate(-50%,-50%);
      width:min(520px, 70%);
      aspect-ratio: 1/1;
      border-radius:50%;
      background: radial-gradient(circle, rgba(61,255,139,.18), transparent 65%);
      filter: blur(1px);
      z-index:0;
    }

    .sideHeart{
      position:fixed;
      right:18px;
      top:50%;
      transform: translateY(-50%);
      z-index:3;
      width:118px;
      height:118px;
      border-radius: 28px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(45px 45px at 30% 28%, rgba(255,255,255,.55), transparent 70%),
        radial-gradient(90px 90px at 70% 78%, rgba(61,255,139,.40), transparent 62%),
        linear-gradient(180deg, rgba(61,255,139,.30), rgba(255,255,255,.06));
      box-shadow:
        0 24px 90px rgba(0,0,0,.40),
        inset 0 1px 0 rgba(255,255,255,.16);
      cursor:pointer;
      user-select:none;
      display:grid;
      place-items:center;
      transition: transform .06s ease;
    }
    .sideHeart:active{ transform: translate(-50%,-50%) scale(.985); }
    .sideHeart .ico{
      font-size:54px;
      filter: drop-shadow(0 14px 28px rgba(0,0,0,.22));
    }
    .sideHeart .tap{
      position:absolute;
      bottom:-34px;
      left:50%;
      transform: translateX(-50%);
      font-size:12px;
      color: rgba(255,255,255,.72);
      white-space:nowrap;
      text-shadow: 0 10px 18px rgba(0,0,0,.35);
    }
    @media (max-width: 980px){
      .sideHeart{
        position:fixed;
        right:14px;
        bottom:16px;
        top:auto;
        transform:none;
        width:96px;
        height:96px;
        border-radius: 24px;
      }
      .sideHeart:active{ transform: scale(.985); }
      .sideHeart .ico{ font-size:46px; }
      .sideHeart .tap{ display:none; }
    }
    
    .centerStrip{
      grid-column: 1 / -1;
      border-radius: var(--radius);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      box-shadow: 0 16px 45px rgba(0,0,0,.35);
    }
    .stripTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(255,255,255,.05));
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .stripTitle{
      font-weight:950;
      letter-spacing:.3px;
      opacity:.92;
    }
    .stripHint{
      font-size:12.5px;
      opacity:.65;
      white-space:nowrap;
    }
    .stripTrack{
      position:relative;
      height:92px;
      background:
        linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px) 0 0/18px 18px,
        linear-gradient(0deg, rgba(255,255,255,.05) 1px, transparent 1px) 0 0/18px 18px,
        radial-gradient(900px 120px at 50% 0%, rgba(61,255,139,.12), transparent 60%),
        rgba(0,0,0,.16);
    }
    .stripTrack::before,
    .stripTrack::after{
      content:"";
      position:absolute;
      left:0; right:0;
      height:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.25));
      opacity:.85;
    }
    .stripTrack::before{ top:0; }
    .stripTrack::after{ bottom:0; }
    .trackRow{
      height:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 0 14px;
      overflow:hidden;
    }
    .trackChip{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
    }
    .trackChip .ico{ font-size:22px; }
    .trackChip .txt{ font-weight:950; font-size:14px; opacity:.92; }
    .trackChip .lvl{ font-family: var(--mono); opacity:.65; font-size:12px; }

    .sideShop{
      padding:0;
      display:flex;
      flex-direction:column;
      height: 92vh;
      max-height: 92vh;
      min-height: 0;
      overflow: hidden;
    }

    .shopHeader{
      padding:14px 16px 12px;
      text-align:center;
      font-weight:950;
      font-size:28px;
      letter-spacing:.6px;
      text-shadow: 0 6px 16px rgba(0,0,0,.55);
      background:
        radial-gradient(700px 140px at 50% 0%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.22), rgba(255,255,255,.03));
      border-bottom: 1px solid rgba(255,255,255,.10);
    }

    .upBar{
      padding:10px 12px 12px;
      background: rgba(0,0,0,.22);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .upBarTitle{
      font-size:12.5px;
      color: rgba(255,255,255,.70);
      margin-bottom:8px;
    }
    .upIcons{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .upIcon{
      width:46px;
      height:46px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
      display:grid;
      place-items:center;
      font-size:22px;
      cursor:pointer;
      position:relative;
    }
    .upIcon.locked{ filter: grayscale(1) brightness(.75); opacity:.65; cursor:default; }
    .upIcon.owned{ outline: 2px solid rgba(61,255,139,.35); }

    .upIcon.rarity-common{
      border-color: rgba(220,220,220,.38);
      background: linear-gradient(180deg, rgba(220,220,220,.14), rgba(255,255,255,.04));
    }
    .upIcon.rarity-epic{
      border-color: rgba(190,140,255,.55);
      background: linear-gradient(180deg, rgba(190,140,255,.18), rgba(255,255,255,.04));
    }
    .upIcon.rarity-legendary{
      border-color: rgba(255,208,96,.72);
      background: linear-gradient(180deg, rgba(255,208,96,.22), rgba(255,255,255,.04));
      box-shadow: 0 0 0 1px rgba(255,208,96,.16), inset 0 1px 0 rgba(255,255,255,.14);
    }


    .shopControls{
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      background: rgba(255,255,255,.05);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }

    .modeTabs{ display:flex; gap:8px; align-items:center; font-weight:900; }
    .modeTabs .tab{
      border:1px solid transparent;
      background: transparent;
      color: rgba(255,255,255,.65);
      font-weight:950;
      padding:6px 8px;
      border-radius:10px;
      cursor:pointer;
    }
    .modeTabs .tab.active{
      color: rgba(255,255,255,.92);
      background: rgba(0,0,0,.25);
      border-color: rgba(255,255,255,.10);
    }

    .qtyTabs{
      display:flex; gap:10px; align-items:center;
      font-family: var(--mono); font-weight:900;
    }
    .qtyTabs .q{
      border:1px solid transparent;
      background: transparent;
      color: rgba(255,255,255,.65);
      padding:6px 8px;
      border-radius:10px;
      cursor:pointer;
    }
    .qtyTabs .q.active{
      color: rgba(255,255,255,.92);
      background: rgba(0,0,0,.25);
      border-color: rgba(255,255,255,.10);
    }

    .shopList{
      flex:1 1 auto;
      min-height:0;
      overflow-y:auto;
      overflow-x:hidden;
      -webkit-overflow-scrolling: touch;
      background:
        radial-gradient(700px 600px at 80% 0%, rgba(61,255,139,.08), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.18));
    
      box-sizing:border-box;
      padding-bottom: max(90px, env(safe-area-inset-bottom));
      scroll-padding-bottom: max(90px, env(safe-area-inset-bottom));
    }
    .shopList::-webkit-scrollbar{ width:12px; }
    .shopList::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.16);
      border-radius:999px;
      border:3px solid rgba(0,0,0,.15);
    }
    .shopList::-webkit-scrollbar-track{ background: rgba(0,0,0,.10); }

    .shopRow{
      display:grid;
      grid-template-columns: 62px 1fr 56px;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      position:relative;
    }
    .shopRow:hover{ background: rgba(255,255,255,.07); }

    .shopRow.disabled{
      opacity:.45;
      filter: saturate(.55);
    }
    .shopRow.disabled:hover{
      background: rgba(255,255,255,.04);
    }

    .shopRow.locked{ cursor:default; opacity:.72; filter: grayscale(.1); }

    .shopRow.bought{ animation: boughtPulse .30s ease-out; }
    @keyframes boughtPulse{
      0%{ transform: scale(1); }
      60%{ transform: scale(1.01); }
      100%{ transform: scale(1); }
    }

    .shopIcon{
      width:52px; height:52px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(24px 24px at 30% 30%, rgba(255,255,255,.10), transparent 70%),
        rgba(0,0,0,.20);
      display:grid;
      place-items:center;
      font-size:26px;
    }
    .shopMain{ display:flex; flex-direction:column; gap:4px; }
    .shopName{
      font-weight:950;
      font-size:22px;
      line-height:1;
      text-shadow: 0 4px 12px rgba(0,0,0,.35);
    }
    .shopCost{
      font-family: var(--mono);
      font-size:13px;
      color: rgba(168,255,204,.90);
      display:flex;
      gap:8px;
      align-items:center;
    }
    .shopCost .c{ color: rgba(255,255,255,.55); }

    .shopBonus{
      font-family: var(--mono);
      font-size:12px;
      color: rgba(255,255,255,.62);
      display:flex;
      gap:8px;
      align-items:center;
    }
    .shopBonus b{ color: rgba(61,255,139,.92); }
    .shopBonus .c{ color: rgba(255,255,255,.46); }

    .shopRightLvl{
      justify-self:end;
      font-weight:950;
      font-size:34px;
      color: rgba(255,255,255,.22);
      text-shadow: 0 10px 22px rgba(0,0,0,.45);
    }

    .tt{
      position:fixed;
      z-index:9999;
      display:none;
      max-width:min(340px, 86vw);
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.92);
      font-size:13px;
      line-height:1.25;
      box-shadow: 0 18px 50px rgba(0,0,0,.40);
    }
    .tt b{ color: rgba(255,255,255,.95); }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(12px);
      color: rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius: 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      font-size:13px;
      display:none;
      max-width:min(720px, 92vw);
      text-align:center;
      z-index:999;
    }
    .toast.show{ display:block; animation: toastIn .15s ease-out; }
    @keyframes toastIn{
      from{transform:translateX(-50%) translateY(6px); opacity:0}
      to{transform:translateX(-50%) translateY(0); opacity:1}
    }

    .pop{
      position:absolute;
      pointer-events:none;
      font-weight:950;
      text-shadow: 0 12px 18px rgba(0,0,0,.25);
      animation: floatUp .9s ease-out forwards;
      white-space:nowrap;
      font-size: 15.5px;
      z-index:4;
    }
    @keyframes floatUp{
      from { transform: translate(-50%, -10%) scale(1); opacity: 1; }
      to   { transform: translate(-50%, -150%) scale(1.10); opacity: 0; }
    }
  
    .centerStrip{ display:none; }
    .panel{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      border-radius: 12px;
      overflow:hidden;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      position:relative;
    }

    .play{ min-height: 640px; }
    .playHeader{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(255,255,255,.03));
    }
    .bigStat .h{ opacity:.8; font-weight:900; letter-spacing:.2px; }
    .bigStat .num{ font-size: 34px; font-weight:1000; color: rgba(168,255,204,.95); text-shadow: 0 10px 24px rgba(0,0,0,.35); }
    .bigStat .sub{ opacity:.8; }

    .playBody{
      position:relative;
      min-height: 560px;
      background:
        radial-gradient(600px 420px at 50% 45%, rgba(61,255,139,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.20));
    }

    .sideHeart{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      width: 300px;
      height: 300px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(120px 120px at 30% 30%, rgba(255,255,255,.55), transparent 65%),
        radial-gradient(180px 180px at 70% 70%, rgba(61,255,139,.25), transparent 62%),
        rgba(0,0,0,.18);
      box-shadow: 0 24px 90px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.14);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
      touch-action: manipulation;
    }
    .sideHeart .ico{ font-size: 96px; filter: drop-shadow(0 14px 22px rgba(0,0,0,.35)); }
    .sideHeart:active{ transform: translate(-50%,-50%) scale(.985); }

    .cursorRing{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      width: 360px;
      height: 360px;
      pointer-events:none;
      opacity:.95;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
    }
    .cursorRing .cur{
      position:absolute;
      left:50%;
      top:50%;
      transform-origin: 0 0;
      font-size: 18px;
    }

    .world{
      min-height: 640px;
      background:
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.24)),
        radial-gradient(900px 700px at 50% 10%, rgba(168,255,204,.06), transparent 60%);
    }
    .worldTop{
      padding: 10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.40), rgba(255,255,255,.02));
    }
    .worldMsg{
      font-weight:900;
      opacity:.88;
      text-shadow: 0 8px 22px rgba(0,0,0,.40);
    }
    .worldSide{ display:flex; gap:10px; align-items:center; opacity:.75; font-size:12.5px; }
    .worldMini{
      padding:6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      white-space:nowrap;
      font-family: var(--mono);
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum" 1, "lnum" 1;
    }
    .worldBody{
      height: calc(100% - 48px);
      overflow: hidden;
      padding: 10px 10px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .worldBody::-webkit-scrollbar{ width:12px; }
    .worldBody::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.16);
      border-radius:999px;
      border:3px solid rgba(0,0,0,.15);
    }

    .lane{
      height: 108px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.22));
      position:relative;
      overflow:hidden;
    }
    .laneTop{
      position:absolute;
      left:10px;
      top:8px;
      font-weight:900;
      font-size:13px;
      opacity:.82;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .laneTop .tag{
      font-family: var(--mono);
      font-size:12px;
      opacity:.65;
    }
    .laneField{
      position:absolute;
      left:0; right:0;
      top:30px; bottom:0;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 0 10px;
      overflow:hidden;
    }
    .sprite{
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      font-size: 22px;
      flex: 0 0 auto;
      opacity:.92;
    }
    .laneEmpty{
      opacity:.55;
      font-size:12.5px;
      padding-left:8px;
    }

    .laneStats{
      position:absolute;
      right:10px;
      top:8px;
      display:flex;
      gap:8px;
      align-items:center;
      font-family: var(--mono);
      font-size:12px;
      opacity:.85;
    }
    .laneStat{
      padding:4px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .laneStat b{ font-weight:900; }
    .laneStat span{ opacity:.75; margin-left:4px; }

    .laneTitle{ display:flex; align-items:center; gap:8px; }
    .laneIco{ font-size:16px; }

    .laneLike{ box-shadow: inset 0 0 0 1px rgba(92,255,170,.08); }
    .laneComment{ box-shadow: inset 0 0 0 1px rgba(143,211,255,.08); }
    .laneMinnie{ box-shadow: inset 0 0 0 1px rgba(255,170,210,.10); }
    .laneYuqi{ box-shadow: inset 0 0 0 1px rgba(255,225,120,.10); }
    .laneShuhua{ box-shadow: inset 0 0 0 1px rgba(210,210,255,.10); }
    .laneSoyeon{ box-shadow: inset 0 0 0 1px rgba(255,215,120,.14); }

    .laneLike::before, .laneComment::before, .laneMinnie::before, .laneYuqi::before, .laneShuhua::before, .laneSoyeon::before{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(closest-side at 20% 20%, rgba(92,255,170,.10), transparent 70%);
      opacity:.0;
      transition: opacity .18s ease;
      pointer-events:none;
    }
    .laneComment::before{ background: radial-gradient(closest-side at 20% 20%, rgba(143,211,255,.10), transparent 70%); }
    .laneMinnie::before{ background: radial-gradient(closest-side at 20% 20%, rgba(255,170,210,.12), transparent 70%); }
    .laneYuqi::before{ background: radial-gradient(closest-side at 20% 20%, rgba(255,225,120,.12), transparent 70%); }
    .laneShuhua::before{ background: radial-gradient(closest-side at 20% 20%, rgba(210,210,255,.12), transparent 70%); }
    .laneSoyeon::before{ background: radial-gradient(closest-side at 20% 20%, rgba(255,215,120,.14), transparent 70%); }
    .lane:hover::before{ opacity:1; }

    .sprite{
      transition: transform .12s ease, filter .12s ease;
    }
    .sprite.wiggle{ animation: wiggle 3.6s ease-in-out infinite; }
    @keyframes wiggle{
      0%,100%{ transform: translateY(0) rotate(0deg); }
      25%{ transform: translateY(-1px) rotate(-2deg); }
      50%{ transform: translateY(1px) rotate(2deg); }
      75%{ transform: translateY(-1px) rotate(1deg); }
    }
    .sprite.pop{ animation: pop .28s ease-out 1; }
    @keyframes pop{
      0%{ transform: scale(.7); filter: brightness(1.15); }
      70%{ transform: scale(1.08); }
      100%{ transform: scale(1); }
    }
    .spriteMore{
      font-family: var(--mono);
      font-weight:900;
      font-size:14px;
      opacity:.85;
      background: rgba(0,0,0,.28);
    }

    .worldLine{
      margin: 10px 12px;
      padding: 10px 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(420px 120px at 30% 0%, rgba(61,255,139,.16), transparent 60%),
        rgba(0,0,0,.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
    }
    .worldLineTop{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      margin-bottom:10px;
    }
    .worldLineTitle{
      font-weight:950;
      letter-spacing:.2px;
      color: rgba(255,255,255,.92);
    }
    .worldLineTitle .muted{ opacity:.65; font-weight:800; margin-left:8px; }
    .worldLineStat{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; opacity:.85; }
    .worldLineStat .muted{ opacity:.65; }

    .worldUnits{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .worldUnits .unit{
      width:38px;
      height:38px;
      display:grid;
      place-items:center;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
      font-size:20px;
    }
    .worldUnits .icoW{
      animation: wiggle 2.6s ease-in-out infinite;
      transform-origin: 50% 80%;
    }
    @keyframes wiggle{
      0%,100%{ transform: rotate(-2deg) translateY(0); }
      50%{ transform: rotate(2deg) translateY(-1px); }
    }
    .unitMore{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      font-weight:950;
      opacity:.85;
    }

    .lineGold{
      background:
        radial-gradient(420px 140px at 30% 0%, rgba(255,210,120,.18), transparent 60%),
        rgba(0,0,0,.18);
      border-color: rgba(255,210,120,.18);
    }
    .lineBlue{
      background:
        radial-gradient(420px 140px at 30% 0%, rgba(143,211,255,.16), transparent 60%),
        rgba(0,0,0,.18);
      border-color: rgba(143,211,255,.18);
    }
    .linePink{
      background:
        radial-gradient(420px 140px at 30% 0%, rgba(255,143,200,.14), transparent 60%),
        rgba(0,0,0,.18);
      border-color: rgba(255,143,200,.18);
    }

    .upPlaceholder{
      color: rgba(255,255,255,.68);
      font-size: 12.5px;
      padding: 10px 12px;
      border:1px dashed rgba(255,255,255,.14);
      border-radius: 12px;
      background: rgba(0,0,0,.16);
    }

    .burstHeart{
      position:absolute;
      left:0;
      top:0;
      transform: translate(-50%,-50%);
      pointer-events:none;
      font-size:18px;
      animation: burst 0.9s ease-out forwards;
      z-index: 2;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.35));
    }
    @keyframes burst{
      0%{ opacity:1; transform: translate(-50%,-50%) scale(1); }
      100%{ opacity:0; transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(.6); }
    }

    .sideHeart.pressed{ transform: translate(-50%,-50%) scale(0.98); }

    .world{ position:relative; overflow:hidden; }
    .worldBody{ position:relative; }
    .worldFX{
      position:absolute;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:0;
    }
    .worldBody > *:not(.worldFX){ position:relative; z-index:1; }

    .fxP{
      position:absolute;
      left: var(--x);
      top: 110%;
      font-size: var(--s);
      opacity: var(--o);
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.25));
      animation: fxRise var(--d) linear forwards;
      will-change: transform, opacity;
    }
    @keyframes fxRise{
      0%{ transform: translate(0,0) rotate(0deg); opacity: var(--o); }
      85%{ opacity: var(--o); }
      100%{ transform: translate(var(--dx), -120vh) rotate(var(--r)); opacity: 0; }
    }

    .worldLine{
      background:
        linear-gradient(180deg, rgba(0,0,0,.35), rgba(255,255,255,.03)),
        radial-gradient(520px 140px at 25% 0%, rgba(61,255,139,.18), transparent 60%),
        rgba(0,0,0,.20);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.10),
        0 14px 40px rgba(0,0,0,.30);
    }
    .worldUnits{
      flex-wrap:nowrap;
      overflow:hidden;
      padding-bottom:2px;
    }
    .worldUnits .unit{
      flex: 0 0 auto;
    }
    .unitMore{
      flex: 0 0 auto;
      background: rgba(0,0,0,.35);
    }

    .centerStrip{ display:none; }

    .unit.pop{ animation: popUnit .22s ease-out 1; }
    @keyframes popUnit{ 0%{ transform: scale(.92); } 70%{ transform: scale(1.06);} 100%{ transform: scale(1);} }

    .worldBody{ position:relative; }
    .chatWrap{
      position:relative;
      z-index:2;
      width:100%;
      height:100%;
      min-height:0;
      padding: 26px 36px 30px;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      gap:12px;
    }
    .chatMsgs{
      display:flex;
      flex-direction:column;
      gap:12px;
      width:100%;
      flex: 1 1 auto;
      justify-content:flex-end;
    }
    .msg{
      display:flex;
      gap:10px;
      align-items:flex-end;
      max-width: 100%;
      animation: fadeUp .28s ease-out;
    }
    .msg.neverland{ align-self:flex-start; }
    .msg.miyeon{ align-self:flex-end; flex-direction:row-reverse; }
    .avatar{
      width:34px; height:34px;
      border-radius: 12px;
      display:grid; place-items:center;
      font-weight:950; font-size:12.5px;
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      flex: 0 0 auto;
    }
    .msg.miyeon .avatar{
      background: rgba(61,255,139,.18);
      border-color: rgba(61,255,139,.35);
      color: #eafff2;
    }
    .bubble{
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    
      max-width: 70%; }
    .msg.neverland .bubble{ background: rgba(255,255,255,.08); }
    .msg.miyeon .bubble{
      background: rgba(61,255,139,.16);
      border-color: rgba(61,255,139,.30);
    }
    .name{
      font-size:12px;
      opacity:.75;
      margin-bottom:6px;
      font-weight:900;
    }
    .text{
      font-size:15px;
      line-height:1.35;
      color: var(--text);
    }

    .typing{
      display:none;
      gap:10px;
      align-items:flex-end;
      max-width: 76%;
      margin-top: 6px;
    }
    .typing.miyeon{ align-self:flex-end; flex-direction:row-reverse; }
    .typing .bubble{ min-width: 170px; }
    .dots{ display:flex; gap:6px; padding-top:2px; }
    .dots span{
      width:6px; height:6px; border-radius:999px;
      background: rgba(255,255,255,.70);
      opacity:.75;
      animation: dot 0.9s infinite ease-in-out;
    }
    .dots span:nth-child(2){ animation-delay:.12s; }
    .dots span:nth-child(3){ animation-delay:.24s; }
    @keyframes dot{
      0%,100%{ transform: translateY(0); opacity:.55; }
      50%{ transform: translateY(-3px); opacity:.95; }
    }
    
html, body { overflow: hidden !important; }

.sideHeart { will-change: transform; }
.sideHeart.pressed { transform: translate(-50%,-50%) scale(0.98) !important; }
.sideHeart:active { transform: translate(-50%,-50%) scale(.985) !important; }

.chatWrap { padding: 26px 44px 34px !important; }


:root{
      --bgA:#06150B;
      --bgB:#0A2B17;

      --green:#3DFF8B;
      --green2:#A8FFCC;

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);

      --stroke: rgba(255,255,255,.12);
      --card: rgba(255,255,255,.06);

      --shadow: 0 22px 70px rgba(0,0,0,.45);
      --radius: 18px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; overflow:hidden; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 850px at 15% 15%, rgba(61,255,139,.14), transparent 60%),
        radial-gradient(900px 700px at 85% 25%, rgba(168,255,204,.10), transparent 55%),
        linear-gradient(160deg, var(--bgA), var(--bgB));
      overflow:hidden;
    }

    .page{
      width:100vw;
      height:100vh;
      display:grid;
      grid-template-rows: auto 1fr;
      gap:12px;
      padding:14px;
    }

    .topbar{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 240px;
    }
    .logo{
      width:42px; height:42px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(18px 18px at 25% 25%, rgba(255,255,255,.75), transparent 70%),
        radial-gradient(26px 26px at 75% 75%, rgba(61,255,139,.18), transparent 70%),
        linear-gradient(180deg, rgba(61,255,139,.20), rgba(255,255,255,.04));
      display:grid;
      place-items:center;
      font-size:18px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.12);
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      line-height:1.12;
    }
    .title b{ font-size:15.5px; letter-spacing:.2px; }
    .title span{ font-size:12.5px; color: var(--muted); }

    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      font-size:12.5px;
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .pill .k{ color: var(--muted); }
    .pill .v{ font-weight:950; }

    /* MAIN GRID: playfield + shop */
    .main{
      width:100%;
      display:grid;
      grid-template-columns: minmax(320px, 360px) 1fr minmax(300px, 360px);
      gap:12px;
      min-height: 0;
      align-items: stretch;
    }
    @media (max-width: 980px){
      .main{
        grid-template-columns: 1fr;
      }
    }

    .panel{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
      position:relative;
      min-height: 0;
    }

    /* PLAYFIELD */
    .play{
      position:relative;
      display:flex;
      flex-direction:column;
      min-height: 640px;
    }

    .playHeader{
      padding:14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 160px at 50% 0%, rgba(61,255,139,.10), transparent 60%),
        rgba(0,0,0,.18);
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }

    .bigStat{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .bigStat .h{
      font-weight:950;
      letter-spacing:.2px;
      opacity:.92;
    }
    .bigStat .num{
      font-weight:950;
      font-size:34px;
      line-height:1;
      text-shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    .bigStat .sub{
      color: var(--muted);
      font-size:12.5px;
    }

    .playBody{
      position:relative;
      flex:1 1 auto;
      min-height:0;
      overflow:hidden;
      background:
        radial-gradient(900px 600px at 50% 45%, rgba(61,255,139,.12), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.18));
    }

    .heartsLayer{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:1;
    }
    .fallHeart{
      position:absolute;
      top:-40px;
      font-size: 22px;
      opacity:.75;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
      animation: fall linear forwards;
    }
    @keyframes fall{
      to{
        transform: translateY(calc(100vh + 120px)) rotate(160deg);
        opacity:.0;
      }
    }

    .glow{
      position:absolute;
      left:50%;
      top:52%;
      transform: translate(-50%,-50%);
      width:min(520px, 70%);
      aspect-ratio: 1/1;
      border-radius:50%;
      background: radial-gradient(circle, rgba(61,255,139,.18), transparent 65%);
      filter: blur(1px);
      z-index:0;
    }

    .sideHeart{
      position:fixed;
      right:18px;
      top:50%;
      transform: translateY(-50%);
      z-index:3;
      width:118px;
      height:118px;
      border-radius: 28px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(45px 45px at 30% 28%, rgba(255,255,255,.55), transparent 70%),
        radial-gradient(90px 90px at 70% 78%, rgba(61,255,139,.40), transparent 62%),
        linear-gradient(180deg, rgba(61,255,139,.30), rgba(255,255,255,.06));
      box-shadow:
        0 24px 90px rgba(0,0,0,.40),
        inset 0 1px 0 rgba(255,255,255,.16);
      cursor:pointer;
      user-select:none;
      display:grid;
      place-items:center;
      transition: transform .06s ease;
    }
    .sideHeart:active{ transform: translate(-50%,-50%) scale(.985); }
    .sideHeart .ico{
      font-size:54px;
      filter: drop-shadow(0 14px 28px rgba(0,0,0,.22));
    }
    .sideHeart .tap{
      position:absolute;
      bottom:-34px;
      left:50%;
      transform: translateX(-50%);
      font-size:12px;
      color: rgba(255,255,255,.72);
      white-space:nowrap;
      text-shadow: 0 10px 18px rgba(0,0,0,.35);
    }
    @media (max-width: 980px){
      .sideHeart{
        position:fixed;
        right:14px;
        bottom:16px;
        top:auto;
        transform:none;
        width:96px;
        height:96px;
        border-radius: 24px;
      }
      .sideHeart:active{ transform: scale(.985); }
      .sideHeart .ico{ font-size:46px; }
      .sideHeart .tap{ display:none; }
    }

    .centerStrip{
      grid-column: 1 / -1;
      border-radius: var(--radius);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      box-shadow: 0 16px 45px rgba(0,0,0,.35);
    }
    .stripTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(255,255,255,.05));
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .stripTitle{
      font-weight:950;
      letter-spacing:.3px;
      opacity:.92;
    }
    .stripHint{
      font-size:12.5px;
      opacity:.65;
      white-space:nowrap;
    }
    .stripTrack{
      position:relative;
      height:92px;
      background:
        linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px) 0 0/18px 18px,
        linear-gradient(0deg, rgba(255,255,255,.05) 1px, transparent 1px) 0 0/18px 18px,
        radial-gradient(900px 120px at 50% 0%, rgba(61,255,139,.12), transparent 60%),
        rgba(0,0,0,.16);
    }
    .stripTrack::before,
    .stripTrack::after{
      content:"";
      position:absolute;
      left:0; right:0;
      height:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.25));
      opacity:.85;
    }
    .stripTrack::before{ top:0; }
    .stripTrack::after{ bottom:0; }
    .trackRow{
      height:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 0 14px;
      overflow:hidden;
    }
    .trackChip{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
    }
    .trackChip .ico{ font-size:22px; }
    .trackChip .txt{ font-weight:950; font-size:14px; opacity:.92; }
    .trackChip .lvl{ font-family: var(--mono); opacity:.65; font-size:12px; }

    .sideShop{
      padding:0;
      display:flex;
      flex-direction:column;
      min-height: 640px;
    }

    .shopHeader{
      padding:14px 16px 12px;
      text-align:center;
      font-weight:950;
      font-size:28px;
      letter-spacing:.6px;
      text-shadow: 0 6px 16px rgba(0,0,0,.55);
      background:
        radial-gradient(700px 140px at 50% 0%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.22), rgba(255,255,255,.03));
      border-bottom: 1px solid rgba(255,255,255,.10);
    }

    .upBar{
      padding:10px 12px 12px;
      background: rgba(0,0,0,.22);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .upBarTitle{
      font-size:12.5px;
      color: rgba(255,255,255,.70);
      margin-bottom:8px;
    }
    .upIcons{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .upIcon{
      width:46px;
      height:46px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
      display:grid;
      place-items:center;
      font-size:22px;
      cursor:pointer;
      position:relative;
    }
    .upIcon.locked{ filter: grayscale(1) brightness(.75); opacity:.65; cursor:default; }
    .upIcon.owned{ outline: 2px solid rgba(61,255,139,.35); }

    .shopControls{
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      background: rgba(255,255,255,.05);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }

    .modeTabs{ display:flex; gap:8px; align-items:center; font-weight:900; }
    .modeTabs .tab{
      border:1px solid transparent;
      background: transparent;
      color: rgba(255,255,255,.65);
      font-weight:950;
      padding:6px 8px;
      border-radius:10px;
      cursor:pointer;
    }
    .modeTabs .tab.active{
      color: rgba(255,255,255,.92);
      background: rgba(0,0,0,.25);
      border-color: rgba(255,255,255,.10);
    }

    .qtyTabs{
      display:flex; gap:10px; align-items:center;
      font-family: var(--mono); font-weight:900;
    }
    .qtyTabs .q{
      border:1px solid transparent;
      background: transparent;
      color: rgba(255,255,255,.65);
      padding:6px 8px;
      border-radius:10px;
      cursor:pointer;
    }
    .qtyTabs .q.active{
      color: rgba(255,255,255,.92);
      background: rgba(0,0,0,.25);
      border-color: rgba(255,255,255,.10);
    }

    .shopList{
      flex:1 1 auto;
      min-height:0;
      overflow-y:auto;
      overflow-x:hidden;
      max-height: calc(92vh - 210px);
      background:
        radial-gradient(700px 600px at 80% 0%, rgba(61,255,139,.08), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.18));
    }
    .shopList::-webkit-scrollbar{ width:12px; }
    .shopList::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.16);
      border-radius:999px;
      border:3px solid rgba(0,0,0,.15);
    }
    .shopList::-webkit-scrollbar-track{ background: rgba(0,0,0,.10); }

    .shopRow{
      display:grid;
      grid-template-columns: 62px 1fr 56px;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      position:relative;
    }
    .shopRow:hover{ background: rgba(255,255,255,.07); }

    .shopRow.disabled{
      opacity:.45;
      filter: saturate(.55);
    }
    .shopRow.disabled:hover{
      background: rgba(255,255,255,.04);
    }

    .shopRow.locked{ cursor:default; opacity:.72; filter: grayscale(.1); }

    .shopRow.bought{ animation: boughtPulse .30s ease-out; }
    @keyframes boughtPulse{
      0%{ transform: scale(1); }
      60%{ transform: scale(1.01); }
      100%{ transform: scale(1); }
    }

    .shopIcon{
      width:52px; height:52px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(24px 24px at 30% 30%, rgba(255,255,255,.10), transparent 70%),
        rgba(0,0,0,.20);
      display:grid;
      place-items:center;
      font-size:26px;
    }
    .shopMain{ display:flex; flex-direction:column; gap:4px; }
    .shopName{
      font-weight:950;
      font-size:22px;
      line-height:1;
      text-shadow: 0 4px 12px rgba(0,0,0,.35);
    }
    .shopCost{
      font-family: var(--mono);
      font-size:13px;
      color: rgba(168,255,204,.90);
      display:flex;
      gap:8px;
      align-items:center;
    }
    .shopCost .c{ color: rgba(255,255,255,.55); }

    .shopBonus{
      font-family: var(--mono);
      font-size:12px;
      color: rgba(255,255,255,.62);
      display:flex;
      gap:8px;
      align-items:center;
    }
    .shopBonus b{ color: rgba(61,255,139,.92); }
    .shopBonus .c{ color: rgba(255,255,255,.46); }

    .shopRightLvl{
      justify-self:end;
      font-weight:950;
      font-size:34px;
      color: rgba(255,255,255,.22);
      text-shadow: 0 10px 22px rgba(0,0,0,.45);
    }

    .tt{
      position:fixed;
      z-index:9999;
      display:none;
      max-width:min(340px, 86vw);
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.92);
      font-size:13px;
      line-height:1.25;
      box-shadow: 0 18px 50px rgba(0,0,0,.40);
    }
    .tt b{ color: rgba(255,255,255,.95); }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(12px);
      color: rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius: 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      font-size:13px;
      display:none;
      max-width:min(720px, 92vw);
      text-align:center;
      z-index:999;
    }
    .toast.show{ display:block; animation: toastIn .15s ease-out; }
    @keyframes toastIn{
      from{transform:translateX(-50%) translateY(6px); opacity:0}
      to{transform:translateX(-50%) translateY(0); opacity:1}
    }

    .pop{
      position:absolute;
      pointer-events:none;
      font-weight:950;
      text-shadow: 0 12px 18px rgba(0,0,0,.25);
      animation: floatUp .9s ease-out forwards;
      white-space:nowrap;
      font-size: 15.5px;
      z-index:4;
    }
    @keyframes floatUp{
      from { transform: translate(-50%, -10%) scale(1); opacity: 1; }
      to   { transform: translate(-50%, -150%) scale(1.10); opacity: 0; }
    }
  
    .centerStrip{ display:none; }
    .panel{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      border-radius: 12px;
      overflow:hidden;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      position:relative;
    }

    .play{ min-height: 640px; }
    .playHeader{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(255,255,255,.03));
    }
    .bigStat .h{ opacity:.8; font-weight:900; letter-spacing:.2px; }
    .bigStat .num{ font-size: 34px; font-weight:1000; color: rgba(168,255,204,.95); text-shadow: 0 10px 24px rgba(0,0,0,.35); }
    .bigStat .sub{ opacity:.8; }

    .playBody{
      position:relative;
      min-height: 560px;
      background:
        radial-gradient(600px 420px at 50% 45%, rgba(61,255,139,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.20));
    }

    .sideHeart{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      width: 300px;
      height: 300px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(120px 120px at 30% 30%, rgba(255,255,255,.55), transparent 65%),
        radial-gradient(180px 180px at 70% 70%, rgba(61,255,139,.25), transparent 62%),
        rgba(0,0,0,.18);
      box-shadow: 0 24px 90px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.14);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
      touch-action: manipulation;
    }
    .sideHeart .ico{ font-size: 96px; filter: drop-shadow(0 14px 22px rgba(0,0,0,.35)); }
    .sideHeart:active{ transform: translate(-50%,-50%) scale(.985); }

    .cursorRing{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      width: 360px;
      height: 360px;
      pointer-events:none;
      opacity:.95;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
    }
    .cursorRing .cur{
      position:absolute;
      left:50%;
      top:50%;
      transform-origin: 0 0;
      font-size: 18px;
    }

    .world{
      min-height: 640px;
      background:
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.24)),
        radial-gradient(900px 700px at 50% 10%, rgba(168,255,204,.06), transparent 60%);
    }
    .worldTop{
      padding: 10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.40), rgba(255,255,255,.02));
    }
    .worldMsg{
      font-weight:900;
      opacity:.88;
      text-shadow: 0 8px 22px rgba(0,0,0,.40);
    }
    .worldSide{ display:flex; gap:10px; align-items:center; opacity:.75; font-size:12.5px; }
    .worldMini{
      padding:6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      white-space:nowrap;
    }
    .worldBody{
      height: calc(100% - 48px);
      overflow: hidden;
      padding: 10px 10px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .worldBody::-webkit-scrollbar{ width:12px; }
    .worldBody::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.16);
      border-radius:999px;
      border:3px solid rgba(0,0,0,.15);
    }

    .lane{
      height: 108px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.22));
      position:relative;
      overflow:hidden;
    }
    .laneTop{
      position:absolute;
      left:10px;
      top:8px;
      font-weight:900;
      font-size:13px;
      opacity:.82;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .laneTop .tag{
      font-family: var(--mono);
      font-size:12px;
      opacity:.65;
    }
    .laneField{
      position:absolute;
      left:0; right:0;
      top:30px; bottom:0;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 0 10px;
      overflow:hidden;
    }
    .sprite{
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      font-size: 22px;
      flex: 0 0 auto;
      opacity:.92;
    }
    .laneEmpty{
      opacity:.55;
      font-size:12.5px;
      padding-left:8px;
    }

    .laneStats{
      position:absolute;
      right:10px;
      top:8px;
      display:flex;
      gap:8px;
      align-items:center;
      font-family: var(--mono);
      font-size:12px;
      opacity:.85;
    }
    .laneStat{
      padding:4px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .laneStat b{ font-weight:900; }
    .laneStat span{ opacity:.75; margin-left:4px; }

    .laneTitle{ display:flex; align-items:center; gap:8px; }
    .laneIco{ font-size:16px; }

    .laneLike{ box-shadow: inset 0 0 0 1px rgba(92,255,170,.08); }
    .laneComment{ box-shadow: inset 0 0 0 1px rgba(143,211,255,.08); }
    .laneMinnie{ box-shadow: inset 0 0 0 1px rgba(255,170,210,.10); }
    .laneYuqi{ box-shadow: inset 0 0 0 1px rgba(255,225,120,.10); }
    .laneShuhua{ box-shadow: inset 0 0 0 1px rgba(210,210,255,.10); }
    .laneSoyeon{ box-shadow: inset 0 0 0 1px rgba(255,215,120,.14); }

    .laneLike::before, .laneComment::before, .laneMinnie::before, .laneYuqi::before, .laneShuhua::before, .laneSoyeon::before{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(closest-side at 20% 20%, rgba(92,255,170,.10), transparent 70%);
      opacity:.0;
      transition: opacity .18s ease;
      pointer-events:none;
    }
    .laneComment::before{ background: radial-gradient(closest-side at 20% 20%, rgba(143,211,255,.10), transparent 70%); }
    .laneMinnie::before{ background: radial-gradient(closest-side at 20% 20%, rgba(255,170,210,.12), transparent 70%); }
    .laneYuqi::before{ background: radial-gradient(closest-side at 20% 20%, rgba(255,225,120,.12), transparent 70%); }
    .laneShuhua::before{ background: radial-gradient(closest-side at 20% 20%, rgba(210,210,255,.12), transparent 70%); }
    .laneSoyeon::before{ background: radial-gradient(closest-side at 20% 20%, rgba(255,215,120,.14), transparent 70%); }
    .lane:hover::before{ opacity:1; }

    .sprite{
      transition: transform .12s ease, filter .12s ease;
    }
    .sprite.wiggle{ animation: wiggle 3.6s ease-in-out infinite; }
    @keyframes wiggle{
      0%,100%{ transform: translateY(0) rotate(0deg); }
      25%{ transform: translateY(-1px) rotate(-2deg); }
      50%{ transform: translateY(1px) rotate(2deg); }
      75%{ transform: translateY(-1px) rotate(1deg); }
    }
    .sprite.pop{ animation: pop .28s ease-out 1; }
    @keyframes pop{
      0%{ transform: scale(.7); filter: brightness(1.15); }
      70%{ transform: scale(1.08); }
      100%{ transform: scale(1); }
    }
    .spriteMore{
      font-family: var(--mono);
      font-weight:900;
      font-size:14px;
      opacity:.85;
      background: rgba(0,0,0,.28);
    }

    .worldLine{
      margin: 10px 12px;
      padding: 10px 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(420px 120px at 30% 0%, rgba(61,255,139,.16), transparent 60%),
        rgba(0,0,0,.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
    }
    .worldLineTop{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      margin-bottom:10px;
    }
    .worldLineTitle{
      font-weight:950;
      letter-spacing:.2px;
      color: rgba(255,255,255,.92);
    }
    .worldLineTitle .muted{ opacity:.65; font-weight:800; margin-left:8px; }
    .worldLineStat{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; opacity:.85; }
    .worldLineStat .muted{ opacity:.65; }

    .worldUnits{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .worldUnits .unit{
      width:38px;
      height:38px;
      display:grid;
      place-items:center;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
      font-size:20px;
    }
    .worldUnits .icoW{
      animation: wiggle 2.6s ease-in-out infinite;
      transform-origin: 50% 80%;
    }
    @keyframes wiggle{
      0%,100%{ transform: rotate(-2deg) translateY(0); }
      50%{ transform: rotate(2deg) translateY(-1px); }
    }
    .unitMore{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      font-weight:950;
      opacity:.85;
    }

    .lineGold{
      background:
        radial-gradient(420px 140px at 30% 0%, rgba(255,210,120,.18), transparent 60%),
        rgba(0,0,0,.18);
      border-color: rgba(255,210,120,.18);
    }
    .lineBlue{
      background:
        radial-gradient(420px 140px at 30% 0%, rgba(143,211,255,.16), transparent 60%),
        rgba(0,0,0,.18);
      border-color: rgba(143,211,255,.18);
    }
    .linePink{
      background:
        radial-gradient(420px 140px at 30% 0%, rgba(255,143,200,.14), transparent 60%),
        rgba(0,0,0,.18);
      border-color: rgba(255,143,200,.18);
    }

    .upPlaceholder{
      color: rgba(255,255,255,.68);
      font-size: 12.5px;
      padding: 10px 12px;
      border:1px dashed rgba(255,255,255,.14);
      border-radius: 12px;
      background: rgba(0,0,0,.16);
    }

    .burstHeart{
      position:absolute;
      left:0;
      top:0;
      transform: translate(-50%,-50%);
      pointer-events:none;
      font-size:18px;
      animation: burst 0.9s ease-out forwards;
      z-index: 2;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.35));
    }
    @keyframes burst{
      0%{ opacity:1; transform: translate(-50%,-50%) scale(1); }
      100%{ opacity:0; transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(.6); }
    }

    .sideHeart.pressed{ transform: translate(-50%,-50%) scale(0.98); }

    .world{ position:relative; overflow:hidden; }
    .worldBody{ position:relative; }
    .worldFX{
      position:absolute;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:0;
    }
    .worldBody > *:not(.worldFX){ position:relative; z-index:1; }

    .fxP{
      position:absolute;
      left: var(--x);
      top: 110%;
      font-size: var(--s);
      opacity: var(--o);
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.25));
      animation: fxRise var(--d) linear forwards;
      will-change: transform, opacity;
    }
    @keyframes fxRise{
      0%{ transform: translate(0,0) rotate(0deg); opacity: var(--o); }
      85%{ opacity: var(--o); }
      100%{ transform: translate(var(--dx), -120vh) rotate(var(--r)); opacity: 0; }
    }

    .worldLine{
      background:
        linear-gradient(180deg, rgba(0,0,0,.35), rgba(255,255,255,.03)),
        radial-gradient(520px 140px at 25% 0%, rgba(61,255,139,.18), transparent 60%),
        rgba(0,0,0,.20);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.10),
        0 14px 40px rgba(0,0,0,.30);
    }
    .worldUnits{
      flex-wrap:nowrap;
      overflow:hidden;
      padding-bottom:2px;
    }
    .worldUnits .unit{
      flex: 0 0 auto;
    }
    .unitMore{
      flex: 0 0 auto;
      background: rgba(0,0,0,.35);
    }

    .centerStrip{ display:none; }


    .unit.pop{ animation: popUnit .22s ease-out 1; }
    @keyframes popUnit{ 0%{ transform: scale(.92); } 70%{ transform: scale(1.06);} 100%{ transform: scale(1);} }

    .worldBody{ position:relative; }
    .chatWrap{
      position:relative;
      z-index:2;
      width:100%;
      height:100%;
      min-height:0;
      padding: 26px 36px 30px;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      gap:12px;
    }
    .chatMsgs{
      display:flex;
      flex-direction:column;
      gap:12px;
      width:100%;
      flex: 1 1 auto;
      justify-content:flex-end;
    }
    .msg{
      display:flex;
      gap:10px;
      align-items:flex-end;
      max-width: 100%;
      animation: fadeUp .28s ease-out;
    }
    .msg.neverland{ align-self:flex-start; }
    .msg.miyeon{ align-self:flex-end; flex-direction:row-reverse; }
    .avatar{
      width:34px; height:34px;
      border-radius: 12px;
      display:grid; place-items:center;
      font-weight:950; font-size:12.5px;
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      flex: 0 0 auto;
    }
    .msg.miyeon .avatar{
      background: rgba(61,255,139,.18);
      border-color: rgba(61,255,139,.35);
      color: #eafff2;
    }
    .bubble{
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    
      max-width: 70%; }
    .msg.neverland .bubble{ background: rgba(255,255,255,.08); }
    .msg.miyeon .bubble{
      background: rgba(61,255,139,.16);
      border-color: rgba(61,255,139,.30);
    }
    .name{
      font-size:12px;
      opacity:.75;
      margin-bottom:6px;
      font-weight:900;
    }
    .text{
      font-size:15px;
      line-height:1.35;
      color: var(--text);
    }

    .typing{
      display:none;
      gap:10px;
      align-items:flex-end;
      max-width: 76%;
      margin-top: 6px;
    }
    .typing.miyeon{ align-self:flex-end; flex-direction:row-reverse; }
    .typing .bubble{ min-width: 170px; }
    .dots{ display:flex; gap:6px; padding-top:2px; }
    .dots span{
      width:6px; height:6px; border-radius:999px;
      background: rgba(255,255,255,.70);
      opacity:.75;
      animation: dot 0.9s infinite ease-in-out;
    }
    .dots span:nth-child(2){ animation-delay:.12s; }
    .dots span:nth-child(3){ animation-delay:.24s; }
    @keyframes dot{
      0%,100%{ transform: translateY(0); opacity:.55; }
      50%{ transform: translateY(-3px); opacity:.95; }
    }

html, body { overflow: hidden !important; }

.sideHeart { will-change: transform; }
.sideHeart.pressed { transform: translate(-50%,-50%) scale(0.98) !important; }
.sideHeart:active { transform: translate(-50%,-50%) scale(.985) !important; }

.chatWrap { padding: 26px 44px 34px !important; }

.stats{
  display:flex !important;
  flex-wrap:nowrap !important;
  gap:10px !important;
  align-items:center !important;
}
.pill{
  flex:0 0 auto !important;
  min-width:118px;
  white-space:nowrap;
}
.pill .v{
  display:inline-block;
  min-width:64px;
  text-align:right;
  font-variant-numeric: tabular-nums;
}
    
#pillTotal{order:1;}
#pillPerClick{order:2;}
#pillAuto{order:3;}
#pillBest{order:4;}

.reset-btn-top {
  align-self: center;
  margin-left: 12px;
  padding: 6px 10px;
  font-size: 12px;
  background: transparent;
  border: 1.5px solid #b94a48;
  color: #b94a48;
  border-radius: 999px;
  cursor: pointer;
  white-space: nowrap;
}
.reset-btn-top:hover {
  background: #b94a48;
  color: #fff;
}

.eventBanner{
  margin: 10px 14px 0;
  padding: 10px 12px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  border-radius: 14px;
  display: flex;
  gap: 10px;
  align-items: center;
  box-shadow: 0 18px 60px rgba(0,0,0,.25);
}
.eventBanner.hidden{ display:none !important; }
.eventBadge{
  font-weight: 800;
  letter-spacing: .08em;
  font-size: 11px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.22);
  background: rgba(255,255,255,.08);
  color: rgba(255,255,255,.9);
  white-space: nowrap;
}
.eventTitle{ font-weight: 800; }
.eventSub{
  margin-top: 2px;
  color: rgba(255,255,255,.72);
  font-size: 12px;
}
.eventTime{ margin-left: 8px; font-weight: 700; color: rgba(255,255,255,.92); }

body.fanmeet .eventBanner{
  border-color: rgba(255, 125, 202, .45);
  box-shadow: 0 20px 70px rgba(255,125,202,.12), 0 18px 60px rgba(0,0,0,.25);
}
body.fanmeet .eventBadge{
  border-color: rgba(255, 125, 202, .55);
  background: rgba(255, 125, 202, .14);
}

body.cuberoulette .eventBanner{
  border-color: rgba(160, 120, 255, .48);
  box-shadow: 0 20px 70px rgba(160,120,255,.14), 0 18px 60px rgba(0,0,0,.25);
}
body.cuberoulette .eventBadge{
  border-color: rgba(160, 120, 255, .58);
  background: rgba(160, 120, 255, .16);
}

.ach-btn-top{
  align-self:center;
  margin-left:12px;
  padding:6px 10px;
  font-size:12px;
  background: transparent;
  border: 1.5px solid rgba(255,255,255,.22);
  color: rgba(255,255,255,.86);
  border-radius: 999px;
  cursor:pointer;
}
.ach-btn-top:hover{ border-color: rgba(255,255,255,.35); }
.ach-btn-top:active{ transform: translateY(1px); }

.stats-btn-top{
  align-self:center;
  margin-left:12px;
  padding:6px 10px;
  font-size:12px;
  background: transparent;
  border: 1.5px solid rgba(255,255,255,.22);
  color: rgba(255,255,255,.86);
  border-radius: 999px;
  cursor:pointer;
}
.stats-btn-top:hover{ border-color: rgba(255,255,255,.35); }
.stats-btn-top:active{ transform: translateY(1px); }

.statsOverlay{
  position:fixed; inset:0;
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(8px);
  display:flex; align-items:center; justify-content:center;
  padding: 18px;
  z-index: 9999;
}
.statsOverlay.hidden{ display:none !important; }

.statsModal{
  width:min(560px, 92vw);
  max-height: 82vh;
  overflow:auto;
  background: rgba(12,20,14,.86);
  border:1px solid rgba(255,255,255,.16);
  border-radius: 18px;
  box-shadow: 0 26px 80px rgba(0,0,0,.55);
  padding: 14px 14px 12px;
}

.statsHeader{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
.statsTitle{ font-size:16px; font-weight:700; }
.statsClose{
  background: transparent;
  border:1px solid rgba(255,255,255,.18);
  color: rgba(255,255,255,.85);
  border-radius: 10px;
  padding: 6px 10px;
  cursor:pointer;
}
.statsClose:hover{ border-color: rgba(255,255,255,.32); }

.statsList{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.statRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  background: rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.12);
  border-radius: 14px;
  padding: 10px 10px 9px;
}
.statLabel{ color: rgba(255,255,255,.80); font-size: 13px; }
.statValue{
  font-weight:950;
  font-family: var(--mono);
  font-variant-numeric: tabular-nums;
  font-feature-settings: "tnum" 1, "lnum" 1;
}
.statsFooter{
  margin-top:10px;
  color: rgba(255,255,255,.72);
  font-size: 12.5px;
}

.achOverlay{
  position:fixed; inset:0;
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(8px);
  display:flex; align-items:center; justify-content:center;
  padding:18px;
  z-index: 9999;
}
.achOverlay.hidden{ display:none !important; }

.achModal{
  width:min(560px, 92vw);
  max-height: 82vh;
  overflow:auto;
  background: rgba(12,20,14,.86);
  border:1px solid rgba(255,255,255,.16);
  border-radius: 18px;
  box-shadow: 0 26px 80px rgba(0,0,0,.55);
  padding: 14px 14px 12px;
}
.achHeader{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
.achTitle{ font-size:16px; font-weight:700; }
.achClose{
  background: transparent;
  border:1px solid rgba(255,255,255,.18);
  color: rgba(255,255,255,.85);
  border-radius: 10px;
  padding: 6px 10px;
  cursor:pointer;
}
.achClose:hover{ border-color: rgba(255,255,255,.32); }

.achList{ display:flex; flex-direction:column; gap:10px; }

.achSectionTitle{
  margin-top: 6px;
  padding: 10px 10px 8px;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(61,255,139,.10), rgba(255,255,255,.03));
  font-weight: 900;
  letter-spacing: .2px;
}
.achSectionSub{
  margin-top: 3px;
  font-size: 12px;
  color: rgba(255,255,255,.70);
  font-weight: 600;
}
.achItem{
  background: rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.12);
  border-radius: 14px;
  padding: 10px 10px 9px;
}
.achRowTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
.achMain{ display:flex; gap:10px; align-items:flex-start; }
.achIcon{
  width:34px; height:34px;
  border-radius: 12px;
  display:grid; place-items:center;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
  font-size:18px;
  flex:0 0 auto;
  margin-top:1px;
}
.achName{ font-weight:700; }
.achDesc{ margin-top:2px; font-size:12px; color: rgba(255,255,255,.70); }
.achBadge{
  font-size:12px;
  padding: 3px 8px;
  border-radius: 999px;
  border:1px solid rgba(255,255,255,.18);
  color: rgba(255,255,255,.80);
  white-space:nowrap;
}
.achBadge.done{
  border-color: rgba(61,255,139,.55);
  color: rgba(61,255,139,.95);
}
.achProg{
  margin-top:8px;
  height:8px;
  border-radius:999px;
  background: rgba(255,255,255,.10);
  overflow:hidden;
}
.achProg > div{
  height:100%;
  width:0%;
  background: rgba(61,255,139,.85);
}
.achFooter{
  margin-top: 12px;
  font-size: 12px;
  color: rgba(255,255,255,.65);
}

.quizOverlay{
  position:fixed; inset:0;
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(8px);
  display:flex; align-items:center; justify-content:center;
  padding: 18px;
  z-index: 10000;
}
.quizOverlay.hidden{ display:none !important; }

.quizModal{
  width:min(560px, 92vw);
  max-height: 82vh;
  overflow:auto;
  background: rgba(12,20,14,.90);
  border:1px solid rgba(255,255,255,.16);
  border-radius: 18px;
  box-shadow: 0 26px 80px rgba(0,0,0,.55);
  padding: 14px 14px 12px;
}

.quizHeader{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
.quizTitle{ font-size:16px; font-weight:800; letter-spacing:.2px; }
.quizClose{
  background: transparent;
  border:1px solid rgba(255,255,255,.18);
  color: rgba(255,255,255,.85);
  border-radius: 10px;
  padding: 6px 10px;
  cursor:pointer;
}
.quizClose:hover{ border-color: rgba(255,255,255,.32); }

.quizBody{ display:flex; flex-direction:column; gap:10px; }
.quizText{
  background: rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.12);
  border-radius: 14px;
  padding: 12px 12px 11px;
  color: rgba(255,255,255,.90);
  line-height:1.35;
}
.quizActions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
.quizBtn{
  border-radius: 14px;
  padding: 10px 12px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.92);
  cursor:pointer;
  font-weight:800;
}
.quizBtn:hover{ border-color: rgba(255,255,255,.32); }
.quizBtn.primary{
  border-color: rgba(61,255,139,.55);
  background: linear-gradient(180deg, rgba(61,255,139,.22), rgba(255,255,255,.05));
}
.quizQ{
  font-weight:900;
  letter-spacing:.2px;
}
.quizOptions{ display:flex; flex-direction:column; gap:10px; }
.quizOpt{
  text-align:left;
  width:100%;
  border-radius: 14px;
  padding: 12px 12px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.05);
  color: rgba(255,255,255,.92);
  cursor:pointer;
  font-weight:700;
}
.quizOpt:hover{ border-color: rgba(255,255,255,.30); }
.quizOpt.correct{ border-color: rgba(61,255,139,.70); }
.quizOpt.wrong{ border-color: rgba(255,120,120,.70); }

.quizFoot{
  margin-top: 8px;
  color: rgba(255,255,255,.70);
  font-size:12.5px;
}

  20%{transform:translateX(-6px)}
  40%{transform:translateX(6px)}
  60%{transform:translateX(-4px)}
  80%{transform:translateX(4px)}
}

@keyframes floatHeart{
  0%{transform:translateY(0) scale(1); opacity:1}
  100%{transform:translateY(-70px) scale(1.15); opacity:0}
}
.fx-heart{
  position:fixed;
  left:var(--x); top:var(--y);
  pointer-events:none;
  font-size:18px;
  animation:floatHeart .7s ease-out forwards;
  filter:drop-shadow(0 6px 10px rgba(0,0,0,.35));
}

.upBarTitle{
  background:transparent;
  border:none;
  color:inherit;
  font:inherit;
  font-weight:800;
  padding:0;
  display:flex;
  align-items:center;
  gap:8px;
  cursor:pointer;
}
.upBarTitle .caret{
  opacity:.75;
  transform:translateY(1px);
}
.upBar.collapsed .upIcons{ display:none; }
.upBar.collapsed .caret{ transform:rotate(-90deg) translateY(1px); }

.clickFloat{
  position:absolute;
  pointer-events:none;
  font-weight:800;
  color:#6CFF9A;
  text-shadow:0 2px 10px rgba(0,0,0,.4);
  opacity:0;
  transform:translateY(0);
  transition:opacity .15s ease, transform .6s ease;
}
.clickFloat.show{
  opacity:1;
  transform:translateY(-28px);
}

.clickPop{
  position:fixed;
  left:0;
  top:0;
  transform:translate(-50%,-50%);
  pointer-events:none;
  font-weight:900;
  font-size:16px;
  color:rgba(108,255,154,1);
  text-shadow:0 2px 10px rgba(0,0,0,.45);
  opacity:0;
  transition:opacity .12s ease, transform .7s ease;
  z-index:1400;
}
.clickPop.show{
  opacity:1;
  transform:translate(-50%,-70%);
}

</style>
</head>
<body>
  <div class="page">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <b>Miyeon Birthday Clicker</b>
          <span></span>
        </div>
      </div>

      <div class="stats">
<button class="stats-btn-top" id="statsBtn" title=""></button>
      <button class="ach-btn-top" id="achBtn" title=""></button>
      <button class="reset-btn-top" onclick="resetProgress()" title=" "></button>
      </div>

      <div class="eventBanner hidden" id="eventBanner" role="status" aria-live="polite">
        <div class="eventBadge"></div>
        <div class="eventText">
          <div class="eventTitle" id="eventTitle">  </div>
          <div class="eventSub" id="eventSub">! <span class="eventTime" id="eventTime"></span></div>
        </div>
      </div>

    </div>

    <div class="main">
      <div class="panel play" id="playPanel">
        <div class="playHeader">
          <div class="bigStat">
            <div class="h"> :</div>
            <div class="num" id="loveBig">0</div>
            <div class="sub"><span id="autoBig">0</span>  </div>
          </div>

          <div class="bigStat">
            <div class="h"></div>
            <div class="sub">   </div>
          </div>
        </div>

        <div class="playBody" id="arena">
          <div class="glow"></div>
          <div class="heartsLayer" id="heartsLayer"></div>

          <div class="cursorRing" id="cursorRing"></div>

          <div class="sideHeart" id="sideHeart" aria-label="">
            <div class="ico"></div>
            <div class="tap">--</div>
          </div>
        </div>
      </div>

      <div class="centerStrip">
        <div class="stripTop">
          <div class="stripTitle"> </div>
          <div class="stripHint" id="stripHint">     </div>
        </div>
        <div class="stripTrack">
          <div class="trackRow" id="trackRow"></div>
        </div>
      </div>

      <div class="panel world" id="worldPanel">
        <div class="worldTop">
          <div class="worldMsg" id="worldMsg">       .</div>
          <div class="worldSide">
            
          </div>
        </div>

        <div class="worldBody" id="worldBody">
          <div class="worldFX" id="worldFX" aria-hidden="true"></div>
          <div class="chatWrap" id="chatWrap">
            <div class="chatMsgs" id="chatMsgs"></div>
            <div class="typing miyeon" id="typing" aria-hidden="true">
              <div class="avatar">MY</div>
              <div class="bubble">
                <div class="name"></div>
                <div class="dots"><span></span><span></span><span></span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel sideShop">
        <div class="shopHeader"></div>

        <div class="upBar">
          <button class="upBarTitle" id="upBarToggle" type="button"> <span class="caret" aria-hidden="true"></span></button>
          <div class="upIcons" id="upgradeIcons"></div>
        </div>

        <div class="shopControls">
          <div class="modeTabs">
            <button class="tab active" data-mode="buy"></button>
            <button class="tab" data-mode="sell"></button>
          </div>

          <div class="qtyTabs" id="qtyTabs">
            <button class="q active" data-m="1">1</button>
            <button class="q" data-m="10">10</button>
            <button class="q" data-m="100">100</button>          </div>
        </div>

        <div class="shopList" id="shopList"></div>
      </div>
    </div>
  </div>

  <div class="tt" id="tt"></div>
  <div class="toast" id="toast"></div>

  <div class="achOverlay hidden" id="achOverlay" aria-hidden="true">
    <div class="achModal" role="dialog" aria-modal="true" aria-label="">
      <div class="achHeader">
        <div class="achTitle"></div>
        <button class="achClose" id="achClose" type="button"></button>
      </div>
      <div class="achList" id="achList"></div>
      <div class="achFooter" id="achFooter"></div>
    </div>
  


  </div>

  <div class="statsOverlay hidden" id="statsOverlay" aria-hidden="true">
    <div class="statsModal" role="dialog" aria-modal="true" aria-label="">
      <div class="statsHeader">
        <div class="statsTitle"></div>
        <button class="statsClose" id="statsClose" type="button"></button>
      </div>

      <div class="statsList" id="statsList">
        <div class="statRow"><div class="statLabel">    </div><div class="statValue" id="statTotalEarned">0</div></div>
        <div class="statRow"><div class="statLabel"> </div><div class="statValue" id="statLoveNow">0</div></div>
        <div class="statRow"><div class="statLabel">  </div><div class="statValue" id="statPerClick">0</div></div>
        <div class="statRow"><div class="statLabel">  </div><div class="statValue" id="statPerSec">0</div></div>
        <div class="statRow"><div class="statLabel"></div><div class="statValue" id="statBest">0</div></div>
        <div class="statRow"><div class="statLabel"> </div><div class="statValue" id="statClicks">0</div></div>
        <div class="statRow"><div class="statLabel"> </div><div class="statValue" id="statSpent">0</div></div>

        <div class="statRow"><div class="statLabel">    </div><div class="statValue" id="statPurchases">0</div></div>
        <div class="statRow"><div class="statLabel">  </div><div class="statValue" id="statTopItem"></div></div>
        <div class="statRow"><div class="statLabel">  </div><div class="statValue" id="statPlayTime">00:00:00</div></div>
      </div>

      <div class="statsFooter" id="statsFooter"></div>
    </div>
  </div>


  <div class="quizOverlay hidden" id="quizOverlay" aria-hidden="true">
    <div class="quizModal" role="dialog" aria-modal="true" aria-label="">
      <div class="quizHeader">
        <div class="quizTitle">  </div>
        <button class="quizClose" id="quizClose" type="button"></button>
      </div>

      <div class="quizBody" id="quizStepReady">
        <div class="quizText">
           ()    <br/>
          ()      1   ?
        </div>
        <div class="quizActions">
          <button class="quizBtn" id="quizNo" type="button"> </button>
          <button class="quizBtn primary" id="quizYes" type="button">!</button>
        </div>
        <div class="quizFoot" id="quizHintReady"></div>
      </div>

      <div class="quizBody hidden" id="quizStepQ">
        <div class="quizText quizQ" id="quizQuestion"></div>
        <div class="quizOptions" id="quizOptions"></div>
        <div class="quizFoot" id="quizHintQ"></div>
      </div>
      <div class="quizBody hidden" id="quizStepBonus">
        <div class="quizText quizQ" id="quizBonusTitle">  </div>
        <div class="quizOptions" id="quizBonusOptions"></div>
        <div class="quizFoot" id="quizHintBonus"></div>
      </div>

    </div>
  </div>

<script>
(() => {
  "use strict";

  const KEY = "miyeon_green_clicker_v2";

    const ITEMS = [{ id:"like",    icon:"", name:"",        desc:"  . +1 /  .",          baseCost:100,  costMult:1.15, add:1 },
{ id:"comment", icon:"", name:"",  desc:"   . +3 /  .",          baseCost:500,  costMult:1.15, add:3 },
{ id:"yg",      icon:"", name:"  YG", desc:"   . +8 /  .",  baseCost:1500, costMult:1.15, add:8 },
{ id:"minnie",  icon:"", name:"",        desc:"     ! +20 /.", baseCost:5000,  costMult:1.15, add:20 },
{ id:"yuqi",    icon:"", name:"",          desc:"    . +80 /.",          baseCost:15000, costMult:1.15, add:80 },
{ id:"shuhua",  icon:"", name:"",        desc:"  ! +260 /.",                    baseCost:60000, costMult:1.15, add:260 },
{ id:"soyeon",  icon:"", name:"",         desc:"  . +900 /.",                          baseCost:300000, costMult:1.15, add:900 },
{ id:"soojin",  icon:"", name:"",       desc:"   . +12 000 /.",             baseCost:35000000,  costMult:1.15, add:12000 },
{ id:"cube",    icon:"", name:"Cube Entertainment",
      desc:" :  10   50%      ( ). : +5%     .",
      baseCost:1500000000, costMult:1.15, add:0 }];

  const MESSAGES = [
    "    , ,  !",
    "  ,    !",
    "  ?    !",
    "    :    ",
    "       ,  !",
    "  !   !",
    "        !",
    "  !  !",
    "   :  +  = ",
    "   :    !",
    "       ",
    "   ,   ",
    "    ",
    "      ",
    "  ,  ",
    "     ",
    "     ",
    "     ",
    "  ,  ",
    "     ",
    "      ",
    "    ",
    "     ",
    "     ",
    "      ",
    "     ",
    "       ",
    "   ",
    "     ",
    "    "
  ];


  const QUIZ_THRESHOLDS = [40,90,160,260,400,600,850,1150,1500,1900,2400,3000,3700,4500,5400];

const state = {
    totalClicks: 0,
    totalEarned: 0,
    totalSpent: 0,
    totalPurchases: 0,
    playTimeMs: 0,
    achievements: {},
    eventSeen: {},
        love: 0,
    best: 0,
    owned: {},          
    upgrades: {},       
    revealedItems: {},  
    boughtUpgrades: {}, 
    clickBase: 1,
    clickLevel: 0,
    clickCpsPct: 0,
    lastSeen: Date.now(),
    event: { type:null, endsAt:0, nextFanAt:0, nextCubeAt:0, cubeMode:null, cubeBonus:0 },
    eventUpgrades: {},
    quiz: { idx: 0, nextAt: (QUIZ_THRESHOLDS[0]||40), used: {}, snoozeUntil: 0},
    quizActive: false,
    buffs: { clickMult: 1, clickMultUntil: 0, shopDiscountLeft: 0, freePurchase: false }
  };

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return;
      const s = JSON.parse(raw);
      if(!s || typeof s !== "object") return;
      Object.assign(state, s);
      state.owned = state.owned || {};
      state.totalPurchases = state.totalPurchases || 0;
      state.playTimeMs = state.playTimeMs || 0;
      state.upgrades = state.upgrades || {};
      state.revealedItems = state.revealedItems || {};
      state.boughtUpgrades = state.boughtUpgrades || {};
      state.eventSeen = state.eventSeen || {};
      state.eventUpgrades = state.eventUpgrades || {};
      state.ui = state.ui || {};
      state._lastTickTs = state._lastTickTs || Date.now();
      state._autoFrac = state._autoFrac || 0;
      state.lastSeen = state.lastSeen || Date.now();
      if(typeof state.clickLevel !== 'number') state.clickLevel = 0;
      if(typeof state.clickBase !== 'number') state.clickBase = 1;
      if(typeof state.clickCpsPct !== 'number') state.clickCpsPct = 0;
      state.event = state.event || { type:null, endsAt:0, nextFanAt:0, nextCubeAt:0, cubeMode:null, cubeBonus:0 };

      state.quiz = state.quiz || { idx: 0, nextAt: (QUIZ_THRESHOLDS[0]||40), used: {}, snoozeUntil: 0};
      state.quiz.used = state.quiz.used || {};
      if(typeof state.quiz.idx !== "number" || state.quiz.idx < 0) state.quiz.idx = 0;

      if(typeof state.quiz.nextAt === "number" && (state.quiz.nextAt > 0) && (!("idx" in state.quiz) || state.quiz.idx === 0)){
        const oldNext = state.quiz.nextAt;
        const mapped = QUIZ_THRESHOLDS.findIndex(t=>t >= oldNext);
        state.quiz.idx = (mapped === -1) ? QUIZ_THRESHOLDS.length : mapped;
      }

      const next = (state.quiz.idx < QUIZ_THRESHOLDS.length) ? QUIZ_THRESHOLDS[state.quiz.idx] : Number.POSITIVE_INFINITY;
      state.quiz.nextAt = next;
      if(typeof state.quiz.snoozeUntil !== "number") state.quiz.snoozeUntil = 0;
      state.quizActive = false;

      state.buffs = state.buffs || { clickMult: 1, clickMultUntil: 0, shopDiscountLeft: 0, freePurchase: false };
      state.quizStats = state.quizStats || { started:0, answered:0, correct:0, streak:0, bestStreak:0, lastStartedIdx:-1, bonusPick:{ perm05:0, x300_10s:0, plus50pct:0, freebuy:0, discount10x:0 } };
      state.quizStats.bonusPick = state.quizStats.bonusPick || { perm05:0, x300_10s:0, plus50pct:0, freebuy:0, discount10x:0 };
      if(typeof state.buffs.clickMult !== "number") state.buffs.clickMult = 1;
      if(typeof state.buffs.clickMultUntil !== "number") state.buffs.clickMultUntil = 0;
      state.buffs.shopDiscountLeft = Number.isFinite(state.buffs.shopDiscountLeft) ? Math.max(0, Math.floor(state.buffs.shopDiscountLeft)) : 0;
      state.buffs.freePurchase = !!state.buffs.freePurchase;
      if(Date.now() > state.buffs.clickMultUntil){ state.buffs.clickMult = 1; state.buffs.clickMultUntil = 0; }


    }catch(_){}
  }
  function persist(){
    try{
      localStorage.setItem(KEY, JSON.stringify(state));
    }catch(_){}
  }

  const $ = (id) => document.getElementById(id);

  const loveEl     = $("love");
  const perClickEl = $("perClick");
  const autoRateEl = $("autoRate");
  const bestEl     = $("best");

  const loveBig = $("loveBig");
  const autoBig = $("autoBig");

  const sideHeart = $("sideHeart");
  const cursorRing = $("cursorRing");

  const worldMsg = $("worldMsg");
  const worldAutoMini = $("worldAutoMini");
  const worldBestMini = $("worldBestMini");
  const chatMsgs = $("chatMsgs");
  const typingEl = $("typing");

  const trackRow = $("trackRow");
  const stripHint = $("stripHint");

  const shopList = $("shopList");
  const upgradeIcons = $("upgradeIcons");
  
  const upBar = document.querySelector(".upBar");
  const upBarToggle = $("upBarToggle");

  function applyUpBarState(){
    state.ui = state.ui || {};
    const collapsed = !!state.ui.upBarCollapsed;
    if(upBar) upBar.classList.toggle("collapsed", collapsed);
    if(upBarToggle) upBarToggle.setAttribute("aria-expanded", collapsed ? "false" : "true");
  }

  if(upBarToggle && upBar){
    upBarToggle.addEventListener("click", ()=>{
      state.ui = state.ui || {};
      state._lastTickTs = state._lastTickTs || Date.now();
      state._autoFrac = state._autoFrac || 0;
      state.ui.upBarCollapsed = !state.ui.upBarCollapsed;
      applyUpBarState();
      save();
    });
  }
const qtyTabs = $("qtyTabs");

  const tt = $("tt");
  const toastEl = $("toast");

  const heartsLayer = $("heartsLayer");

  const quizOverlay = $("quizOverlay");
  const quizClose   = $("quizClose");
  const quizYes     = $("quizYes");
  const quizNo      = $("quizNo");
  const quizStepReady = $("quizStepReady");
  const quizStepQ     = $("quizStepQ");
  const quizStepBonus = $("quizStepBonus");
  const quizBonusTitle = $("quizBonusTitle");
  const quizBonusOptions = $("quizBonusOptions");
  const quizHintBonus = $("quizHintBonus");
  const quizQuestion  = $("quizQuestion");
  const quizOptions   = $("quizOptions");
  const quizHintReady = $("quizHintReady");
  const quizHintQ     = $("quizHintQ");

  if(quizOverlay){ quizOverlay.classList.add("hidden"); quizOverlay.setAttribute("aria-hidden","true"); }


  const fmt = (n) => {
    if(!isFinite(n)) return "0";
    const abs = Math.abs(n);
    if(abs >= 1e9) return (n/1e9).toFixed(abs>=1e10?0:1) + "B";
    if(abs >= 1e6) return (n/1e6).toFixed(abs>=1e7?0:1) + "M";
    if(abs >= 1e3) return (n/1e3).toFixed(abs>=1e4?0:1) + "K";
    return Math.floor(n).toLocaleString("ru-RU");
  };

  const shuffleInPlace = (arr) => {
    for(let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  };

  const getOwned = (id) => Math.max(0, state.owned[id] || 0);
  const setOwned = (id, v) => { state.owned[id] = Math.max(0, Math.floor(v||0)); };

  const isRevealed = (id) => !!state.revealedItems[id];
  const revealItem = (id) => {
    if(state.revealedItems[id]) return false;
    state.revealedItems[id] = true;
    return true;
  };

  function toastLong(msg){
    if(!toastEl) return;
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toastLong._t);
    toastLong._t = setTimeout(()=>toastEl.classList.remove("show"), 2600);
  }

  const ACHIEVEMENTS = [
    // Visible (obvious)
    { id:"first_click",  icon:"", name:" ", desc:"    1 .", hidden:false, cat:"-",
      prog:()=> ((state.totalClicks||state.clicks||0) >= 1 ? 1 : 0) },

    { id:"first_unlock", icon:"", name:"! ", desc:"    .", hidden:false, cat:"-",
      prog:()=> Math.min(1, Object.keys(state.revealedItems||{}).length / 1) },

    { id:"first_buy",    icon:"", name:" ", desc:"    .", hidden:false, cat:"-",
      prog:()=> Math.min(1, (totalOwnedAll()) / 1) },

{ id:"idle_together", icon:"", name:"(G)IDLE  ", desc:" , , ,   .", hidden:true, cat:"Neverland",
      prog:()=> {
        const ids = ["minnie","shuhua","yuqi","soyeon","soojin"];
        const have = ids.filter(id => getOwned(id) > 0).length;
        return Math.min(1, have / ids.length);
      } },

    
    { id:"yg_first", icon:"", name:" ", desc:"   YG 1 .", hidden:false, cat:"Neverland",
      prog:()=> Math.min(1, getOwned("yg") / 1) },

    { id:"yg_lvl5",  icon:"", name:",   ", desc:"   YG  5 .", hidden:false, cat:"Neverland",
      prog:()=> Math.min(1, getOwned("yg") / 5) },

{ id:"love_1k",      icon:"", name:"1 000 ", desc:"  1 000 .", hidden:false, cat:"-",
      prog:()=> Math.min(1, (state.best||0) / 1000) },

    { id:"auto_10",      icon:"", name:" ", desc:" /  10.", hidden:false, cat:"-",
      prog:()=> Math.min(1, autoRate() / 10) },

    { id:"up_1",         icon:"", name:"!", desc:"  .", hidden:false, cat:"-",
      prog:()=> Math.min(1, Object.keys(state.boughtUpgrades||{}).length / 1) },

    { id:"love_10k",     icon:"", name:"10 000 ", desc:"  10 000 .", hidden:false, cat:"-",
      prog:()=> Math.min(1, (state.best||0) / 10000) },

    { id:"love_100k",    icon:"", name:"100 000 ", desc:"  100 000 .", hidden:false, cat:"-",
      prog:()=> Math.min(1, (state.best||0) / 100000) },

    { id:"love_1m",      icon:"", name:"1 000 000 ", desc:"  1 000 000 .", hidden:false, cat:"-",
      prog:()=> Math.min(1, (state.best||0) / 1000000) },

    { id:"love_1b", icon:"", name:"1 000 000 000 ", desc:"  1 000 000 000 .", hidden:true, cat:"-",
      prog:()=> Math.min(1, (Number(state.best||0) / 1_000_000_000)) },

    { id:"auto_1k",      icon:"", name:"", desc:" /  1 000.", hidden:false, cat:"-",
      prog:()=> Math.min(1, autoRate() / 1000) },

    { id:"auto_10k",     icon:"", name:"", desc:" /  10 000.", hidden:false, cat:"-",
      prog:()=> Math.min(1, autoRate() / 10000) },

    { id:"collector_25", icon:"", name:"", desc:"  25 .", hidden:false, cat:"-",
      prog:()=> Math.min(1, totalOwnedAll() / 25) },

    { id:"collector_100",icon:"", name:" ", desc:"  100 .", hidden:false, cat:"-",
      prog:()=> Math.min(1, totalOwnedAll() / 100) },

    { id:"all_upgrades", icon:"", name:" ", desc:"      (,  ,  , Birthday Click).", hidden:false, cat:"-",
      prog:()=> Math.min(1, upgradeKindsBought() / 4) },

    { id:"click_monster",icon:"", name:"  ", desc:"     50.", hidden:false, cat:"-",
      prog:()=> Math.min(1, perClickStable() / 50) },

    { id:"fan_minnie",   icon:"", name:" ", desc:"  10 .", hidden:true, cat:"Neverland",
      prog:()=> Math.min(1, getOwned("minnie") / 10) },

    { id:"fan_yuqi",     icon:"", name:" ", desc:"  10 .", hidden:true, cat:"Neverland",
      prog:()=> Math.min(1, getOwned("yuqi") / 10) },

    { id:"fan_shuhua",   icon:"", name:" ", desc:"  10 .", hidden:true, cat:"Neverland",
      prog:()=> Math.min(1, getOwned("shuhua") / 10) },

    { id:"fan_soyeon",   icon:"", name:" ", desc:"  10 .", hidden:true, cat:"Neverland",
      prog:()=> Math.min(1, getOwned("soyeon") / 10) },

    { id:"soojin_support",icon:"", name:" ", desc:"  1 .", hidden:true, cat:"Neverland",
      prog:()=> Math.min(1, getOwned("soojin") / 1) },

    { id:"cube_installed",icon:"", name:" ", desc:" Cube Entertainment 1 .", hidden:false, cat:"Neverland",
      prog:()=> Math.min(1, getOwned("cube") / 1) },

    { id:"idle_party",   icon:"", name:"i-dle ", desc:" , ,       1.", hidden:true, cat:"Neverland",
      prog:()=> {
        const ok = (getOwned("minnie")>0) && (getOwned("yuqi")>0) && (getOwned("shuhua")>0) && (getOwned("soyeon")>0);
        return ok ? 1 : 0;
      } 
    },
    
    { id:"fanmeet_once", icon:"", name:"!", desc:"     1 .", hidden:true, cat:"",
      prog:()=> (state.eventSeen && state.eventSeen.fanmeet) ? 1 : 0 },


    { id:"cube_bonus",   icon:"", name:"!", desc:" Cube Roulette   .", hidden:true, cat:"",
      prog:()=> (state.eventSeen && state.eventSeen.cubeBonus) ? 1 : 0 },
  
    { id:"quiz_first", icon:"", name:" ", desc:"       1 .", hidden:false, cat:"",
      prog:()=> Math.min(1, ((state.quizStats&&state.quizStats.answered)||0) / 1) },

    { id:"quiz_3_correct", icon:"", name:"", desc:" 3    .", hidden:false, cat:"",
      prog:()=> Math.min(1, ((state.quizStats&&state.quizStats.correct)||0) / 3) },

    { id:"quiz_10_correct", icon:"", name:"  ", desc:" 7    .", hidden:true, cat:"",
      prog:()=> Math.min(1, ((state.quizStats&&state.quizStats.correct)||0) / 7) },

    { id:"quiz_10_total", icon:"", name:"", desc:"  7   .", hidden:true, cat:"",
      prog:()=> Math.min(1, ((state.quizStats&&state.quizStats.answered)||0) / 7) },

    { id:"quiz_streak_5", icon:"", name:"", desc:"   5   .", hidden:true, cat:"",
      prog:()=> Math.min(1, ((state.quizStats&&state.quizStats.bestStreak)||0) / 5) },

    { id:"bonus_perm", icon:"", name:" ", desc:"  +5%      1 .", hidden:true, cat:"",
      prog:()=> Math.min(1, (((state.quizStats&&state.quizStats.bonusPick)||{}).perm05||0) / 1) },

    { id:"bonus_x300", icon:"", name:"", desc:"  300    10    1 .", hidden:true, cat:"",
      prog:()=> Math.min(1, (((state.quizStats&&state.quizStats.bonusPick)||{}).x300_10s||0) / 1) },

    { id:"bonus_plus50", icon:"", name:" ", desc:"  +50%     1 .", hidden:true, cat:"",
      prog:()=> Math.min(1, (((state.quizStats&&state.quizStats.bonusPick)||{}).plus50pct||0) / 1) },

    { id:"bonus_freebuy", icon:"", name:"", desc:"      1 .", hidden:true, cat:"", cat:"",
      prog:()=> Math.min(1, (((state.quizStats&&state.quizStats.bonusPick)||{}).freebuy||0) / 1) },

    { id:"bonus_discount", icon:"", name:" ", desc:"   10%  10    1 .", hidden:true, cat:"", cat:"",
      prog:()=> Math.min(1, (((state.quizStats&&state.quizStats.bonusPick)||{}).discount10x||0) / 1) },

    { id:"quiz_5400", icon:"", name:"  5400", desc:"    5400 .", hidden:true, cat:"",
      prog:()=> Math.min(1, (Number(state.totalClicks||0) >= 5400 ? 1 : 0)) },

];

  function isAchDone(id){ return !!(state.achievements && state.achievements[id]); }

  function totalOwnedAll(){
    const o = state.owned || {};
    let s = 0;
    for(const k in o){ s += (+o[k]||0); }
    return s;
  }

  function upgradeKindsBought(){
    const bought = state.boughtUpgrades || {};
    let shop = false, clickMult = false, clickPower = false, clickScale = false;

    for(const id of Object.keys(bought)){
      if(!bought[id]) continue;
      if(/^click_u\d+$/i.test(id)) clickMult = true;
      else if(/^click_p\d+$/i.test(id)) clickPower = true;
      else if(/^click_s\d+$/i.test(id)) clickScale = true;
      else if(/_u\d+$/i.test(id)) shop = true;
      if(shop && clickMult && clickPower && clickScale) break;
    }
    let c = 0;
    if(shop) c++;
    if(clickMult) c++;
    if(clickPower) c++;
    if(clickScale) c++;
    return c;
  }

function totalUpgradesGoal(){
    return (ITEMS.length * 3) + 6;
  }

  function unlockAch(id){
    state.achievements = state.achievements || {};
    if(state.achievements[id]) return false;
    state.achievements[id] = Date.now();
    persist();
    const a = ACHIEVEMENTS.find(x=>x.id===id);
    toastLong(` : ${a ? a.name : id} `);
    return true;
  }

  function checkAchievements(){
    let changed = false;
    for(const a of ACHIEVEMENTS){
      if(isAchDone(a.id)) continue;
      const p = Math.max(0, Math.min(1, (a.prog ? a.prog() : 0)));
      if(p >= 1){ if(unlockAch(a.id)) changed = true; }
    }
    if(changed) renderAchievements();
  }

  const achBtn = $("achBtn");
  const achOverlay = $("achOverlay");
  const achClose = $("achClose");
  const achList = $("achList");
  const achFooter = $("achFooter");

  function openAchievements(){
    if(!achOverlay) return;
    achOverlay.classList.remove("hidden");
    achOverlay.setAttribute("aria-hidden","false");
    renderAchievements();
  }
  function closeAchievements(){
    if(!achOverlay) return;
    achOverlay.classList.add("hidden");
    achOverlay.setAttribute("aria-hidden","true");
  }

  function renderAchievements(){
    function isAchVisible(a){
      if(!a.hidden) return true;
      if(isAchDone(a.id)) return true;

      const cat = a.cat || "";
      if(cat === ""){
        return !!(((state.quizStats||{}).answered||0) >= 1);
      }
      if(cat === ""){
        const s = state.eventSeen || {};
        return !!(s.fanmeet || s.cubeGood || s.cubeBad || s.cubeNothing || s.cubeBonus);
      }

      if(cat === "Neverland"){
        const map = {
          fan_minnie: "minnie",
          fan_yuqi: "yuqi",
          fan_shuhua: "shuhua",
          fan_soyeon: "soyeon",
          fan_soojin: "soojin",
          idle_party: null,      
          idle_together: null,   
          yg_first: null,
          yg_lvl5: null
        };

        if(map[a.id]){
          return getOwned(map[a.id]) > 0;
        }

        if(a.id === "idle_party"){
          return ["minnie","yuqi","shuhua","soyeon"].every(m => getOwned(m)>0);
        }

        if(a.id === "idle_together"){
          return ["minnie","yuqi","shuhua","soyeon","soojin"].every(m => getOwned(m)>0);
        }

        if(a.id === "yg_first" || a.id === "yg_lvl5"){
          return getOwned("yg") > 0;
        }

        return false;
      }

      return false;
    }

    if(!achList) return;

    const done = (state.achievements && Object.keys(state.achievements).length) ? Object.keys(state.achievements).length : 0;
    achList.innerHTML = "";

    const groups = new Map();

    ACHIEVEMENTS.forEach((a, idx)=>{
      let cat = a.cat || "";
      if(a.id.startsWith("cube_") || a.id === "fanmeet_once") cat = "";
      if(a.id.startsWith("quiz_") || a.id.startsWith("bonus_")) cat = "";
      if(a.id.startsWith("fan_") || a.id === "idle_party" || a.id === "idle_together" || a.id === "soojin_support" || a.id.startsWith("yg_")) cat = "Neverland";
      if(["first_click","first_unlock","first_buy","up_1","love_1k","love_10k","love_100k","love_1m","auto_10","auto_1k","auto_10k","click_monster","collector_25","collector_100","all_upgrades"].includes(a.id)) cat = "-";
      if(!groups.has(cat)) groups.set(cat, []);
      groups.get(cat).push({ a, idx });
    });

    const order = [];
    if(groups.has("-")) order.push("-");
    if(groups.has("Neverland")) order.push("Neverland");
    if(groups.has("")) order.push("");
    if(groups.has("")) order.push("");
    for(const k of Array.from(groups.keys()).filter(k=>!["-","Neverland","",""].includes(k)).sort((a,b)=>a.localeCompare(b,"ru"))){
      order.push(k);
    }

    for(const cat of order){
      const header = document.createElement("div");
      header.className = "achSectionTitle";
      header.innerHTML = `<div>${cat}</div>` + (cat==="-" ? `<div class="achSectionSub">,     </div>` : (cat==="Neverland" ? `<div class="achSectionSub">,    </div>` : (cat==="" ? `<div class="achSectionSub">    </div>` : (cat==="" ? `<div class="achSectionSub">,    ? </div>` : ``))));
      achList.appendChild(header);

      for(const item of (groups.get(cat)||[])){
        const a = item.a;
        const achNum = item.idx + 1;

        let p = Math.max(0, Math.min(1, a.prog ? a.prog() : 0));
        if(a.hidden && !isAchDone(a.id) && !isAchVisible(a)) p = 0;

        const row = document.createElement("div");
        row.className = "achItem";
        const badge = isAchDone(a.id) ? '<span class="achBadge done"></span>' : `<span class="achBadge">${Math.floor(p*100)}%</span>`;
        row.innerHTML = `
          <div class="achRowTop">
            <div class="achMain">
              <div class="achIcon">${isAchVisible(a) ? (a.icon || "") : ""}</div>
              <div>
                <div class="achName">${isAchVisible(a) ? a.name : `  ${achNum}`}</div>
                <div class="achDesc">${isAchVisible(a) ? a.desc : ""}</div>
              </div>
            </div>
            ${badge}
          </div>
          <div class="achProg"><div style="width:${Math.floor(p*100)}%"></div></div>
        `;
        achList.appendChild(row);
      }
    }

    if(achFooter) achFooter.textContent = `: ${done}/${ACHIEVEMENTS.length}`;
  }

  if(achBtn) achBtn.addEventListener("click", openAchievements);
  if(achClose) achClose.addEventListener("click", closeAchievements);
  if(achOverlay) achOverlay.addEventListener("click", (e)=>{ if(e.target === achOverlay) closeAchievements(); });

const statsBtn = $("statsBtn");
const statsOverlay = $("statsOverlay");
const statsClose = $("statsClose");


function formatTimeMs(ms){
  const total = Math.max(0, Math.floor((Number(ms)||0)/1000));
  const h = String(Math.floor(total/3600)).padStart(2,"0");
  const m = String(Math.floor((total%3600)/60)).padStart(2,"0");
  const s = String(total%60).padStart(2,"0");
  return `${h}:${m}:${s}`;
}
function getTopItemLabel(){
  try{
    let bestId = null;
    let bestN = 0;
    for(const it of (typeof ITEMS !== "undefined" ? ITEMS : [])){
      const n = Math.floor((state.owned && state.owned[it.id]) || 0);
      if(n > bestN){ bestN = n; bestId = it.id; }
    }
    if(!bestId || bestN<=0) return "";
    const it = (typeof ITEMS !== "undefined" ? ITEMS : []).find(x=>x.id===bestId);
    return `${it ? it.name : bestId} ${bestN}`;
  }catch(_){
    return "";
  }
}

function renderStats(){
  const elTotal = $("statTotalEarned");
  const elNow   = $("statLoveNow");
  const elPC    = $("statPerClick");
  const elPS    = $("statPerSec");
  const elBest  = $("statBest");
  const elClk   = $("statClicks");
  const elSpent = $("statSpent");
  const elPurch = $("statPurchases");
  const elTop   = $("statTopItem");
  const elTime  = $("statPlayTime");
  const footer  = $("statsFooter");

  const totalEarned = Math.floor(state.totalEarned || 0);
  const nowLove = Math.floor(state.love || 0);
  const pc = perClick();
  const ps = autoRate();
  const best = Math.floor(state.best || 0);
  const clicks = Math.floor(state.totalClicks || 0);
  const spent = Math.floor(state.totalSpent || 0);
  const purchases = Math.floor(state.totalPurchases || 0);
  const topItem = getTopItemLabel();
  const playTime = formatTimeMs(state.playTimeMs || 0);

  if(elTotal) elTotal.textContent = fmt(totalEarned);
  if(elNow)   elNow.textContent   = fmt(nowLove);
  if(elPC)    elPC.textContent    = fmt(pc);
  if(elPS)    elPS.textContent    = fmt(ps);
  if(elBest)  elBest.textContent  = fmt(best);
  if(elClk)   elClk.textContent   = fmt(clicks);
  if(elSpent) elSpent.textContent = fmt(spent);
  if(elPurch) elPurch.textContent = fmt(purchases);
  if(elTop)   elTop.textContent   = topItem;
  if(elTime)  elTime.textContent  = playTime;

  if(footer){
    }
}

function openStats(){
  if(!statsOverlay) return;
  renderStats();
  statsOverlay.classList.remove("hidden");
  statsOverlay.setAttribute("aria-hidden","false");
}
function closeStats(){
  if(!statsOverlay) return;
  statsOverlay.classList.add("hidden");
  statsOverlay.setAttribute("aria-hidden","true");
}

if(statsBtn) statsBtn.addEventListener("click", openStats);
if(statsClose) statsClose.addEventListener("click", closeStats);
if(statsOverlay) statsOverlay.addEventListener("click", (e)=>{ if(e.target === statsOverlay) closeStats(); });


  function announceReveal(itemId){
    const it = ITEMS.find(x=>x.id===itemId);
    if(!it) return;
    toastLong(`  : ${it.icon} ${it.name}  ${it.desc}`);
    checkAchievements();
  }

  const upgradeLevel = (itemId) => Math.max(0, Math.min(6, state.upgrades[itemId] || 0));
  const upgradeMult  = (itemId) => Math.pow(2, upgradeLevel(itemId));

  function toast(msg){
    if(!toastEl) return;
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toastEl.classList.remove("show"), 1200);
  }

  const QUIZ_POOL = [
    { id:"q01", q:"     ?", a:["","","",""], correct:2 },
    { id:"q02", q:"      ?", a:["","","",""], correct:3 },
    { id:"q03", q:"    ?", a:["  ","  ","  ","  "], correct:2 },
    { id:"q04", q:"      ?", a:[" "," ","  ,   ","  "], correct:1 },
    { id:"q05", q:"      ?", a:[" "," "," ",",   "], correct:3 },
    { id:"q06", q:"      ?", a:["","","",""], correct:2 },
    { id:"q07", q:"    ?", a:["","","  ",""], correct:2 },
    { id:"q08", q:"     ?", a:["","","",""], correct:1 },
    { id:"q09", q:"   ?", a:["  "," ","  "," "], correct:2 },
    { id:"q10", q:"    ?", a:[" ","","",""], correct:0 },
    { id:"q11", q:"     ?", a:["","","",""], correct:2 },
    { id:"q12", q:"     ?", a:[" ","  ",",   ","  "], correct:2 },
    { id:"q13", q:"      ?", a:["","","",""], correct:2 },
    { id:"q14", q:"     ?", a:[" "," "," "," "], correct:2 },
    { id:"q15", q:"      ?", a:["SM Entertainment","JYP Entertainment","YG Entertainment","Cube Entertainment"], correct:2 },
    { id:"q16", q:"     YG Entertainment   ?", a:[" "," "," "," "], correct:3 },
    { id:"q17", q:"     BLACKPINK?", a:["   ","   "," "," "], correct:1 },
    { id:"q18", q:"      ?", a:["  ","  ","  "," "], correct:1 },
    { id:"q19", q:"    ?", a:[" "," ","  ","  "], correct:3 },
    { id:"q20", q:"   ,   ?", a:["  "," "," "," "], correct:1 },
    { id:"q21", q:"     ?", a:["","","",""], correct:3 },
    { id:"q22", q:"         Cube?", a:[" ","","",""], correct:2 },
    { id:"q23", q:"      (G)I-DLE?", a:["2016","2017","2018","2019"], correct:2 },
    { id:"q24", q:"     (G)I-DLE?", a:["Hann","Oh My God","Latata","Uh-Oh"], correct:2 },
    { id:"q25", q:"     K/DA?", a:["","","",""], correct:2 },
    { id:"q26", q:"        My?", a:["Rose","Drive","Te Amo","Rain"], correct:1 },
    { id:"q27", q:"     - My?", a:["2020","2021","2022","2023"], correct:2 },
    { id:"q28", q:"     POP/STARS,    ?", a:["aespa","K/DA","Heartsteel","True Damage"], correct:1 },
    { id:"q29", q:"   (G)I-DLE   OST We Already Fell In Love?", a:["","","",""], correct:2 },
    { id:"q30", q:"        ?", a:["Queendom","Weekly Idol","King of Mask Singer","Immortal Songs"], correct:2 },
    { id:"q31", q:"    - ,   2025 ?", a:["Lover","My Again","My, Lover","Blooming"], correct:2 },
    { id:"q32", q:"      Side Effect?", a:["Gray","Raiden","Loco","DPR LIVE"], correct:1 }
  ];

  let lastQuizInviteClick = -1;
  let quizYesLocked = false;
  let quizInBonusChoice = false;

  let quizPhase = "ready";
  let currentQuiz = null;

  function setQuizPhase(phase){
    quizPhase = phase;

    if(quizStepReady) quizStepReady.classList.toggle("hidden", phase !== "ready");
    if(quizStepQ)     quizStepQ.classList.toggle("hidden", phase !== "question");
    if(quizStepBonus) quizStepBonus.classList.toggle("hidden", phase !== "bonus");

    if(quizNo)  quizNo.disabled  = (phase !== "ready");
    if(quizYes) quizYes.disabled = (phase !== "ready") || quizYesLocked;

    if(quizClose) quizClose.disabled = (phase === "bonus");
  }

  function openQuizReady(){
    if(!quizOverlay) return;

    quizYesLocked = false;
    quizInBonusChoice = false;
    currentQuiz = null;
    if(quizYes) quizYes.disabled = false;

    state.quizActive = true;
    quizOverlay.classList.remove("hidden");
    quizOverlay.setAttribute("aria-hidden","false");

    setQuizPhase("ready");
  }

  function closeQuiz(){
    if(!quizOverlay) return;
    quizOverlay.classList.add("hidden");
    quizOverlay.setAttribute("aria-hidden","true");
    state.quizActive = false;

    quizInBonusChoice = false;
    quizYesLocked = false;
    currentQuiz = null;
    setQuizPhase("ready");
  }

  function pickQuizQuestion(){
    const used = (state.quiz && state.quiz.used) ? state.quiz.used : {};
    const available = QUIZ_POOL.filter(x=>!used[x.id]);
    if(available.length === 0) return null;
    return available[Math.floor(Math.random()*available.length)];
  }

  function prepareQuestion(qobj){
    const options = qobj.a.map((label, i)=>({ label, isCorrect: i === qobj.correct }));
    shuffleInPlace(options);
    return { qobj, options };
  }

  function advanceQuizThreshold(){
    state.quiz = state.quiz || { idx: 0, nextAt: (QUIZ_THRESHOLDS[0]||40), used: {}, snoozeUntil: 0};
    state.quiz.used = state.quiz.used || {};

    state.quiz.idx = (Number.isFinite(state.quiz.idx) ? state.quiz.idx : 0) + 1;
    state.quiz.nextAt = (state.quiz.idx < QUIZ_THRESHOLDS.length) ? QUIZ_THRESHOLDS[state.quiz.idx] : Number.POSITIVE_INFINITY;
    state.quiz.snoozeUntil = 0;
  }

  function startQuizQuestion(){
    if(!quizOverlay) return;

    state.quizStats = state.quizStats || { started:0, answered:0, correct:0, streak:0, bestStreak:0, lastStartedIdx:-1, bonusPick:{ perm05:0, x300_10s:0, plus50pct:0, freebuy:0, discount10x:0 } };
    if(state.quiz && Number.isFinite(state.quiz.idx) && state.quizStats.lastStartedIdx !== state.quiz.idx){
      state.quizStats.started += 1;
      state.quizStats.lastStartedIdx = state.quiz.idx;
      persist();
      checkAchievements();
    }

    if(!currentQuiz){
      const qobj = pickQuizQuestion();
      if(!qobj){
        toast("  ");
        closeQuiz();
        return;
      }
      currentQuiz = prepareQuestion(qobj);

      state.quiz = state.quiz || { idx: 0, nextAt: (QUIZ_THRESHOLDS[0]||40), used: {}, snoozeUntil: 0};
      state.quiz.used = state.quiz.used || {};
      state.quiz.used[qobj.id] = true;
      persist();
    }

    if(quizQuestion) quizQuestion.textContent = currentQuiz.qobj.q;
    if(quizOptions){
      quizOptions.innerHTML = "";
      currentQuiz.options.forEach((opt)=>{
        const b = document.createElement("button");
        b.type = "button";
        b.className = "quizOpt";
        b.textContent = opt.label;

        b.addEventListener("click", ()=>{
          [...quizOptions.querySelectorAll("button.quizOpt")].forEach(x=>x.disabled=true);

          state.quizStats = state.quizStats || { started:0, answered:0, correct:0, streak:0, bestStreak:0, lastStartedIdx:-1, bonusPick:{ perm05:0, x300_10s:0, plus50pct:0, freebuy:0, discount10x:0 } };
          state.quizStats.answered = (state.quizStats.answered||0) + 1;

          if(opt.isCorrect){
            b.classList.add("correct");
            state.quizStats.correct = (state.quizStats.correct||0) + 1;
            state.quizStats.streak = (state.quizStats.streak||0) + 1;
            state.quizStats.bestStreak = Math.max(state.quizStats.bestStreak||0, state.quizStats.streak||0);
            persist();
            checkAchievements();
            openQuizBonusChoice();
          }else{
            b.classList.add("wrong");
            state.quizStats.streak = 0;
            persist();
            checkAchievements();
            toastLong("   ");
            advanceQuizThreshold();
            persist();
            renderAll(true);
            setTimeout(closeQuiz, 650);
          }
        });

        quizOptions.appendChild(b);
      });
    }
    if(quizHintQ) quizHintQ.textContent = "    ";

    setQuizPhase("question");
  }

  function unlockedQuizBonuses(){
    const clicks = Number(state.totalClicks||0);
    const list = [
      {
        id: "perm05",
        title: " +5%   ",
        desc: "     5%.       .",
        isUnlocked: () => true,
        apply: () => {
          state.clickBase = (state.clickBase || 1) * 1.05;
          toastLong(` +5%       : ${Math.floor(perClick()).toLocaleString("ru-RU")} /`);
        }
      },
      {
        id: "x300_10s",
        title: " 300    10 ",
        desc: "   300  10 .      .",
        isUnlocked: () => true,
        apply: () => {
          state.buffs = state.buffs || { clickMult: 1, clickMultUntil: 0, shopDiscountLeft: 0, freePurchase: false };
      state.quizStats = state.quizStats || { started:0, answered:0, correct:0, streak:0, bestStreak:0, lastStartedIdx:-1, bonusPick:{ perm05:0, x300_10s:0, plus50pct:0, freebuy:0, discount10x:0 } };
      state.quizStats.bonusPick = state.quizStats.bonusPick || { perm05:0, x300_10s:0, plus50pct:0, freebuy:0, discount10x:0 };
          state.buffs.clickMult = 300;
          state.buffs.clickMultUntil = Date.now() + 10000;
          toastLong(" 300    10 !");
        }
      },
      {
        id: "plus50pct",
        title: " +50%  ",
        desc: "  +50%    .",
        isUnlocked: () => clicks >= 260,
        apply: () => {
          const cur = Math.floor(Number(state.love||0));
          const add = Math.floor(cur * 0.5);
          gainLove(add);
          toastLong(` +${fmt(add)}  (50%  )`);
        }
      },
      {
        id: "freebuy",
        title: "  ",
        desc: "      (1 ).",
        isUnlocked: () => clicks >= 850,
        apply: () => {
          state.buffs = state.buffs || { clickMult: 1, clickMultUntil: 0, shopDiscountLeft: 0, freePurchase: false };
      state.quizStats = state.quizStats || { started:0, answered:0, correct:0, streak:0, bestStreak:0, lastStartedIdx:-1, bonusPick:{ perm05:0, x300_10s:0, plus50pct:0, freebuy:0, discount10x:0 } };
      state.quizStats.bonusPick = state.quizStats.bonusPick || { perm05:0, x300_10s:0, plus50pct:0, freebuy:0, discount10x:0 };
          state.buffs.freePurchase = true;
          toastLong("      !");
        }
      },
      {
        id: "discount10x",
        title: "  10%  10 ",
        desc: "     10%  10 .         10.",
        isUnlocked: () => clicks >= 1500,
        apply: () => {
          state.buffs = state.buffs || { clickMult: 1, clickMultUntil: 0, shopDiscountLeft: 0, freePurchase: false };
      state.quizStats = state.quizStats || { started:0, answered:0, correct:0, streak:0, bestStreak:0, lastStartedIdx:-1, bonusPick:{ perm05:0, x300_10s:0, plus50pct:0, freebuy:0, discount10x:0 } };
      state.quizStats.bonusPick = state.quizStats.bonusPick || { perm05:0, x300_10s:0, plus50pct:0, freebuy:0, discount10x:0 };
          state.buffs.shopDiscountLeft = 10;
          toastLong("  10%   10 !");
        }
      }
    ];

    return list.filter(x=>x.isUnlocked());
  }

  function openQuizBonusChoice(){
    if(!quizStepBonus || !quizBonusOptions || !quizBonusTitle) return;

    quizInBonusChoice = true;
    quizYesLocked = true;

    quizBonusTitle.textContent = " !   ";
    if(quizHintBonus){
      const clicks = Number(state.totalClicks||0);
      quizHintBonus.textContent = `     ( : ${fmt(clicks)}).`;
    }

    const bonuses = unlockedQuizBonuses();
    quizBonusOptions.innerHTML = "";

    bonuses.forEach((bns)=>{
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "quizOpt";
      btn.textContent = bns.title;
      btn.title = bns.desc;

      btn.addEventListener("click", ()=>{
        [...quizBonusOptions.querySelectorAll("button")].forEach(x=>x.disabled=true);

        state.quizStats = state.quizStats || { started:0, answered:0, correct:0, streak:0, bestStreak:0, lastStartedIdx:-1, bonusPick:{ perm05:0, x300_10s:0, plus50pct:0, freebuy:0, discount10x:0 } };
        state.quizStats.bonusPick = state.quizStats.bonusPick || { perm05:0, x300_10s:0, plus50pct:0, freebuy:0, discount10x:0 };
        if(state.quizStats.bonusPick[bns.id] !== undefined){
          state.quizStats.bonusPick[bns.id] = (state.quizStats.bonusPick[bns.id]||0) + 1;
        }
        persist();
        checkAchievements();

        bns.apply();

        advanceQuizThreshold();

        persist();
        renderAll(true);
        setTimeout(closeQuiz, 650);
      });

      quizBonusOptions.appendChild(btn);
    });

    setQuizPhase("bonus");
  }

  function forceMaybeTriggerQuiz(){
    if(!quizOverlay) return;

    state.quiz = state.quiz || { idx: 0, nextAt: (QUIZ_THRESHOLDS[0]||40), used: {}, snoozeUntil: 0};
    state.quiz.used = state.quiz.used || {};

    let idx = Number.isFinite(state.quiz.idx) ? state.quiz.idx : 0;
    if(idx < 0) idx = 0;
    if(idx >= QUIZ_THRESHOLDS.length) return;

    const nextAt = QUIZ_THRESHOLDS[idx];
    state.quiz.idx = idx;
    state.quiz.nextAt = nextAt;

    const nowClicks = Number(state.totalClicks||0);
    const snoozeUntil = Number.isFinite(state.quiz.snoozeUntil) ? state.quiz.snoozeUntil : 0;

    if(state.quizActive) return;
    if(nowClicks < snoozeUntil) return;
    if(nowClicks < nextAt) return;

    if(lastQuizInviteClick === nowClicks) return;
    lastQuizInviteClick = nowClicks;

    openQuizReady();
  }

  function maybeTriggerQuizByClicks(){
    forceMaybeTriggerQuiz();
  }

  if(quizOverlay){
    quizOverlay.addEventListener("pointerdown", (e)=>{
      if(e.target === quizOverlay){
        if(quizPhase === "bonus"){ toast("  "); return; }
        closeQuiz();
      }
    });
  }
  if(quizClose) quizClose.addEventListener("click", ()=>{
    if(quizPhase === "bonus"){ toast("  "); return; }
    closeQuiz();
  });
  if(quizNo) quizNo.addEventListener("click", ()=>{
    state.quiz = state.quiz || { idx: 0, nextAt: (QUIZ_THRESHOLDS[0]||40), used: {}, snoozeUntil: 0};

    const nextIdx = Number(state.quiz.idx||0) + 1;
    state.quiz.idx = nextIdx;
    state.quiz.snoozeUntil = 0;
    state.quiz.nextAt = (QUIZ_THRESHOLDS[nextIdx] != null) ? QUIZ_THRESHOLDS[nextIdx] : 1e18;
    persist();

    quizYesLocked = false;
    if(quizYes) quizYes.disabled = false;
    currentQuiz = null;

    closeQuiz();
  });
  if(quizYes) quizYes.addEventListener("click", ()=>{
    if(quizYesLocked) return;
    quizYesLocked = true;
    if(quizYes) quizYes.disabled = true;

    startQuizQuestion();
  });

  function unitPrice(item){
    const c = getOwned(item.id);
    return Math.floor((item.baseCost * Math.pow(item.costMult, c)) * fanmeetShopDiscount() * quizShopDiscount());
  }
  function totalPrice(item, mult){
    const c = getOwned(item.id);
    const k = Math.max(1, mult|0);
    const r = item.costMult;
    const base = item.baseCost * Math.pow(r, c);
    if(k === 1) return Math.floor(base * fanmeetShopDiscount() * quizShopDiscount());
    const sum = base * (Math.pow(r, k) - 1) / (r - 1);
    return Math.floor(sum * fanmeetShopDiscount() * quizShopDiscount());
  }
  function canAfford(cost){ return state.love >= cost; }


function gainLove(amount){
  const a = Number(amount) || 0;
  if(a === 0) return;
  state.love += a;
  state.best = Math.max(state.best || 0, state.love);
  if(a > 0) state.totalEarned = (state.totalEarned || 0) + a;
}


  const FANMEET = {
    durationMs: 60000,
    minGapMs: 6 * 60000,
    maxGapMs: 10 * 60000,
    clickMult: 1,
    autoMult: 1.5
  };

  const CUBEROULETTE = {
    durationMs: 30000,
    minGapMs: 5 * 60000,
    maxGapMs: 10 * 60000
  };

  function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }

  function eventGapFactor(key){
    const lvl = (state.eventUpgrades && state.eventUpgrades[key]) ? state.eventUpgrades[key] : 0;
    if(!lvl) return 1;
    return Math.pow(0.5, lvl);
  }

  function ensureEventState(){
    if(!state.event) state.event = { type:null, endsAt:0, nextFanAt:0, nextCubeAt:0, cubeMode:null, cubeBonus:0, cubeClickMult:1, cubeAutoOff:false };
  }

  function scheduleNextFanMeet(fromTs){
    ensureEventState();
    const base = (fromTs ?? Date.now());
    const gap = Math.floor(randInt(FANMEET.minGapMs, FANMEET.maxGapMs) * eventGapFactor('fanmeet'));
    state.event.nextFanAt = base + gap;
  }

  function scheduleNextCubeRoulette(fromTs){
    ensureEventState();
    const base = (fromTs ?? Date.now());
    const gap = Math.floor(randInt(CUBEROULETTE.minGapMs, CUBEROULETTE.maxGapMs) * eventGapFactor('cube'));
    state.event.nextCubeAt = base + gap;
  }

  function ensureSchedules(){
    ensureEventState();
    const now = Date.now();

    if(!state.event.nextFanAt) scheduleNextFanMeet(now);
    if(!state.event.nextCubeAt) scheduleNextCubeRoulette(now);

    if(state.event.nextFanAt - now > FANMEET.maxGapMs) scheduleNextFanMeet(now);
    if(state.event.nextCubeAt - now > CUBEROULETTE.maxGapMs) scheduleNextCubeRoulette(now);
  }

  function isEventActive(){
    ensureEventState();
    return state.event.type && Date.now() < (state.event.endsAt || 0);
  }
  function activeType(){ return isEventActive() ? state.event.type : null; }

  function baseAutoRate(){
    let sum = 0;
    for(const [id, n] of Object.entries(state.owned || {})){
      const item = ITEMS.find(x => x.id === id);
      if(!item) continue;
      sum += (item.cps || 0) * (n||0);
    }
    return Math.max(0, Math.floor(sum * globalAutoMult()));
  }

  function startFanMeet(){
  const now = Date.now();
  state.eventSeen = state.eventSeen || {};
  state.eventSeen.fanmeet = true;

  const canV3 = fanmeetV3Unlocked();
  const pool = canV3 ? [1,2,3] : [1,2];
  const variant = pool[Math.floor(Math.random()*pool.length)];

  state.event.type = "fanmeet";
  state.event.fanVariant = variant;

  const dur = (variant===1) ? 13*1000 : 10*1000;
  state.event.endsAt = now + dur;

  state.event.cubeMode = null;
      state.event.cubeBonus = 0;
      state.event.cubeClickMult = 1;
      state.event.cubeAutoOff = false;
  scheduleNextFanMeet(state.event.endsAt);
}

  function startCubeRoulette(){
    const now = Date.now();
    state.event.type = "cuberoulette";

    const roll = Math.random();
    let mode = "tiny";
    if(roll < 0.30) mode = "tiny";
    else if(roll < 0.55) mode = "long";
    else if(roll < 0.75) mode = "sprint";
    else if(roll < 0.90) mode = "ultra";
    else if(roll < 0.98) mode = "jackpot";
    else mode = "error";

    state.event.cubeMode = mode;
    state.event.cubeBonus = 0;
    state.event.cubeClickMult = 1;
    state.event.cubeAutoOff = false;

    let dur = 10000;
    if(mode==="tiny"){ dur = 10000; state.event.cubeClickMult = 15; }
    if(mode==="long"){ dur = 18000; state.event.cubeClickMult = 60; }
    if(mode==="sprint"){ dur = 12000; state.event.cubeClickMult = 120; }
    if(mode==="ultra"){ dur = 8000;  state.event.cubeClickMult = 300; }
    if(mode==="jackpot"){ dur = 6000; state.event.cubeClickMult = 450; }
    if(mode==="error"){ dur = 15000; state.event.cubeAutoOff = true; state.event.cubeClickMult = 600; }

    state.event.endsAt = now + dur;

    state.eventSeen = state.eventSeen || {};
    if(mode==="ultra" || mode==="jackpot") state.eventSeen.cubeGood = true;
    if(mode==="error") state.eventSeen.cubeBad = true;
    if(mode==="tiny") state.eventSeen.cubeNothing = true;
    if(mode==="jackpot") state.eventSeen.cubeBonus = true;

    if(mode==="jackpot"){
      const base = state.clickBase || 1;
      const mult = clickMultFromLevel(state.clickLevel||0);
      const pct = Math.max(0, state.clickCpsPct || 0);
      const fromProd = autoRate() * pct; 
      const rawClick = (base * mult + fromProd);
      const bonus = Math.max(1500, Math.floor(rawClick * 1200));
      state.event.cubeBonus = bonus;
      gainLove(bonus);
    }

    scheduleNextCubeRoulette(state.event.endsAt);
  }

  function maybeStartEvents(){
    ensureSchedules();
    const now = Date.now();

    if(state.event.type && now >= (state.event.endsAt || 0)){
      state.event.type = null;
      state.event.endsAt = 0;
      state.event.cubeMode = null;
      state.event.cubeBonus = 0;
    }
    if(isEventActive()) return;

    const fanDue  = now >= state.event.nextFanAt;
    const cubeDue = now >= state.event.nextCubeAt;

    if(cubeDue && (!fanDue || state.event.nextCubeAt <= state.event.nextFanAt)){
      startCubeRoulette();
    }else if(fanDue){
      startFanMeet();
    }
  }

  function eventClickMult(){
  if(activeType()==="fanmeet"){
    const v = fanmeetVariant();
    if(v===1) return 777;
    if(v===3) return fanmeetV3Mult();
    return 1;
  }
  if(activeType()==="cuberoulette"){
    return (state.event && state.event.cubeClickMult) ? state.event.cubeClickMult : 1;
  }
  return 1;
}

  function eventAutoMult(){
  if(activeType()==="fanmeet") return 1;
  if(activeType()==="cuberoulette"){
    return (state.event && state.event.cubeAutoOff) ? 0 : 1;
  }
  return 1;
}

function fanmeetVariant(){
  return (state.event && state.event.type==="fanmeet") ? (state.event.fanVariant||1) : 1;
}
function fanmeetV3Unlocked(){
  return getOwned("minnie")>=1 && getOwned("soyeon")>=1 && getOwned("shuhua")>=1 && getOwned("yuqi")>=1;
}
function fanmeetV3Mult(){
  const total = getOwned("minnie")+getOwned("soyeon")+getOwned("shuhua")+getOwned("yuqi");
  return Math.max(1, total + 7);
}
function fanmeetShopDiscount(){
  return (activeType()==="fanmeet" && fanmeetVariant()===2) ? 0.95 : 1;
}

function quizShopDiscount(){
  return (state.buffs && (state.buffs.shopDiscountLeft||0) > 0) ? 0.90 : 1;
}

function perClickStable(){
    const base = state.clickBase || 1;
    const mult = clickMultFromLevel(state.clickLevel||0);

    const pct = Math.max(0, state.clickCpsPct || 0);
    const fromProd = baseAutoRate() * pct;

    return (base * mult + fromProd);
  }

  function perClick(){
    const base = state.clickBase || 1;
    const mult = clickMultFromLevel(state.clickLevel||0);

    const pct = Math.max(0, state.clickCpsPct || 0);
    const fromProd = autoRate() * pct;

    const tmpMult = (state.buffs && Date.now() < (state.buffs.clickMultUntil||0)) ? (state.buffs.clickMult||1) : 1;
    return (base * mult + fromProd) * eventClickMult() * tmpMult;
  }


  function baseAutoRate(){
    let a = 0;
    for(const it of ITEMS){
      const c = getOwned(it.id);
      if(c<=0) continue;
      a += (it.add || 0) * c * upgradeMult(it.id);
    }
    return Math.max(0, Math.floor(a));
  }

  function globalAutoMult(){
    const c = getOwned("cube");
    return Math.pow(1.05, c);
  }

  function autoRate(){
    const base = baseAutoRate();
    return Math.max(0, Math.floor(base * globalAutoMult() * eventAutoMult()));
  }

  function upgradeChain(item){
    const base = Math.max(1000, Math.floor(item.baseCost * 10));
    return [
      { id:`${item.id}_u1`, itemId:item.id, icon:item.icon, name:`${item.name} I`,   desc:" x2",             cost: base,        level:1, rarity:"common" },
      { id:`${item.id}_u2`, itemId:item.id, icon:item.icon, name:`${item.name} II`,  desc:" x2",             cost: base*6,      level:2, rarity:"rare",      prereq:`${item.id}_u1` },
      { id:`${item.id}_u3`, itemId:item.id, icon:item.icon, name:`${item.name} III`, desc:" x2",             cost: base*25,     level:3, rarity:"epic",      prereq:`${item.id}_u2` },
      { id:`${item.id}_u4`, itemId:item.id, icon:item.icon, name:`${item.name} IV`,  desc:" x2",            cost: base*80,     level:4, rarity:"epic",      prereq:`${item.id}_u3` },
      { id:`${item.id}_u5`, itemId:item.id, icon:item.icon, name:`${item.name} V`,   desc:" x2",            cost: base*250,    level:5, rarity:"legendary", prereq:`${item.id}_u4` },
      { id:`${item.id}_u6`, itemId:item.id, icon:item.icon, name:`${item.name} VI`,  desc:" x2",            cost: base*800,    level:6, rarity:"legendary", prereq:`${item.id}_u5` },
    ];
  }
const UPGRADES = ITEMS.flatMap(upgradeChain);

const CLICK_UPGRADES = [
  { id:"click_u1", itemId:"__click", icon:"", name:"  I",  desc:" :    2",                 cost: 3000,   level:1, rarity:"common" },
  { id:"click_u2", itemId:"__click", icon:"", name:"  II", desc:" :    5 ( )",        cost: 15000,   level:2, rarity:"epic", prereq:"click_u1" },
  { id:"click_u3", itemId:"__click", icon:"", name:"  III",desc:":    12 ( )",        cost: 80000,  level:3, rarity:"legendary", prereq:"click_u2" },
];

UPGRADES.push(...CLICK_UPGRADES);

const CLICK_POWER = [
  { id:"click_p1", itemId:"__click", icon:"", name:"  I", desc:"+1   ", cost: 500, add: 1, prereq:null },
  { id:"click_p2", itemId:"__click", icon:"", name:"  II", desc:"+3   ", cost: 2500, add: 3, prereq:"click_p1" },
  { id:"click_p3", itemId:"__click", icon:"", name:"  III", desc:"+10   ", cost: 12000, add: 10, prereq:"click_p2" },
];

UPGRADES.push(...CLICK_POWER);

const CLICK_SCALE_UPGRADES = [
  { id:"click_s1", itemId:"__click", icon:"", name:"Birthday Click  I",  desc:"  +1%   /.",  cost: 1000,   pctAdd: 0.01, unlockClicks: 100,   prereq:null,        rarity:"common" },
  { id:"click_s2", itemId:"__click", icon:"", name:"Birthday Click  II", desc:"   +1%   /.", cost: 10000,  pctAdd: 0.01, unlockClicks: 1000,  prereq:"click_s1",  rarity:"epic" },
  { id:"click_s3", itemId:"__click", icon:"", name:"Birthday Click  III",desc:"   +1%   /.", cost: 100000, pctAdd: 0.01, unlockClicks: 10000, prereq:"click_s2",  rarity:"legendary" },
  { id:"click_s4", itemId:"__click", icon:"", name:"Birthday Click  IV", desc:"   +1%   /.", cost: 1000000,pctAdd: 0.01, unlockClicks: 100000,prereq:"click_s3",  rarity:"legendary" },
];
UPGRADES.push(...CLICK_SCALE_UPGRADES);

const EVENT_FREQ_UPGRADES = [
  { id:"freq_fan",    eventKey:"fanmeet",itemId:"__event", icon:"", name:" ",   desc:"   2  .",          cost: 180000, rarity:"rare" },
  { id:"freq_cube",   eventKey:"cube",   itemId:"__event", icon:"", name:"Cube Roulette ", desc:"Cube Roulette   2  .",     cost: 260000, rarity:"epic" },
];
UPGRADES.push(...EVENT_FREQ_UPGRADES);

const LEVEL_MILESTONES = [1, 10, 25, 50, 100, 200, 300, 400, 500, 750, 1000];

(function assignUpgradeLevels(){
  const groups = {};
  for (const u of UPGRADES){
    if (!u || !u.itemId) continue;
    if (u.itemId === "__click") continue;
    if (u.eventKey) continue;
    groups[u.itemId] = groups[u.itemId] || [];
    groups[u.itemId].push(u);
  }
  Object.keys(groups).forEach(itemId=>{
    const arr = groups[itemId].slice().sort((a,b)=> (a.cost||0) - (b.cost||0));
    for (let i=0;i<arr.length;i++){
      if (arr[i].unlockLevel == null){
        arr[i].unlockLevel = LEVEL_MILESTONES[Math.min(i, LEVEL_MILESTONES.length-1)];
      }
    }
  });
})();


function clickMultFromLevel(lvl){
  if(lvl>=3) return 12;
  if(lvl==2) return 5;
  if(lvl==1) return 2;
  return 1;
}


  function hasBoughtUpgrade(upId){ return !!state.boughtUpgrades[upId]; }

  function canShowUpgrade(u){    if(u.unlockLevel && getOwned(u.itemId) < u.unlockLevel) return false;

    if(hasBoughtUpgrade(u.id)) return false; 
    if(u.prereq && !hasBoughtUpgrade(u.prereq)) return false;

    if(typeof u.unlockClicks === "number" && (state.totalClicks||0) < u.unlockClicks) return false;

    if(!u.eventKey && u.itemId !== "__click" && getOwned(u.itemId) <= 0) return false;

    return true;
  }

  function buyUpgrade(u){
    if(hasBoughtUpgrade(u.id)) return false;
    if(u.prereq && !hasBoughtUpgrade(u.prereq)) return false;
    if(!u.eventKey && u.itemId !== "__click" && getOwned(u.itemId) <= 0) return false;
    if(!canAfford(u.cost)) return false;

    state.love -= u.cost;
    state.totalSpent = (state.totalSpent||0) + u.cost;
    state.totalPurchases = (state.totalPurchases||0) + 1;

    if(u.eventKey){
      state.eventUpgrades = state.eventUpgrades || {};
      state.ui = state.ui || {};
      state._lastTickTs = state._lastTickTs || Date.now();
      state._autoFrac = state._autoFrac || 0;
      state.eventUpgrades[u.eventKey] = u.level || 1;
    }
    if(u.itemId === "__click"){
      if(u.level) state.clickLevel = u.level;
      if(u.add) state.clickBase += u.add;
      if(u.pctAdd) state.clickCpsPct = (state.clickCpsPct || 0) + u.pctAdd;
    }else{
      state.upgrades[u.itemId] = u.level;
    }
    state.boughtUpgrades[u.id] = true;
    persist();
    checkAchievements();
    toast("  ");
    return true;
  }

  function showTT(html, x, y){
    if(!tt) return;
    tt.innerHTML = html;
    tt.style.display = "block";
    const pad = 14;
    const w = tt.offsetWidth;
    const h = tt.offsetHeight;
    let left = x + 14;
    let top = y + 14;
    if(left + w + pad > window.innerWidth) left = x - w - 14;
    if(top + h + pad > window.innerHeight) top = y - h - 14;
    tt.style.left = left + "px";
    tt.style.top = top + "px";
  }
  function hideTT(){ if(tt) tt.style.display = "none"; }
  window.addEventListener("scroll", hideTT, {passive:true});
  window.addEventListener("resize", hideTT);

  function spawnFallingHeart(){
    if(!heartsLayer) return;
    const el = document.createElement("div");
    el.className = "fallHeart";
    el.textContent = "";
    el.style.left = (Math.random()*100) + "%";
    el.style.fontSize = (14 + Math.random()*18) + "px";
    el.style.animationDuration = (4 + Math.random()*5) + "s";
    el.style.opacity = (0.35 + Math.random()*0.55).toFixed(2);
    heartsLayer.appendChild(el);
    setTimeout(()=>el.remove(), 9000);
  }

  function burstHearts(x, y){
    if(!heartsLayer) return;
    const n = 10 + Math.floor(Math.random()*8);
    for(let i=0;i<n;i++){
      const p = document.createElement("div");
      p.className = "burstHeart";
      p.textContent = "";
      const ang = Math.random()*Math.PI*2;
      const dist = 40 + Math.random()*60;
      p.style.left = x + "px";
      p.style.top = y + "px";
      p.style.setProperty("--dx", Math.cos(ang)*dist + "px");
      p.style.setProperty("--dy", Math.sin(ang)*dist + "px");
      heartsLayer.appendChild(p);
      setTimeout(()=>p.remove(), 900);
    }
  }

  setInterval(()=>{ spawnFallingHeart(); if(Math.random()<0.55) spawnFallingHeart(); if(Math.random()<0.25) spawnFallingHeart(); }, 380);

  const worldFX = document.getElementById("worldFX");
  function spawnWorldParticle(){
    if(!worldFX) return;

    const pool = ["","",""];
    if(getOwned("yuqi")>0) pool.push("");
    if(getOwned("soyeon")>0) pool.push("");
    if(getOwned("shuhua")>0) pool.push("");

    const el = document.createElement("div");
    el.className = "fxP";
    el.textContent = pool[Math.floor(Math.random()*pool.length)];

    const x = Math.random()*100;
    const s = 14 + Math.random()*18;
    const o = (0.10 + Math.random()*0.25).toFixed(2);
    const d = 6 + Math.random()*7;
    const dx = (-40 + Math.random()*80).toFixed(1) + "px";
    const r = (-40 + Math.random()*80).toFixed(1) + "deg";

    el.style.setProperty("--x", x + "%");
    el.style.setProperty("--s", s + "px");
    el.style.setProperty("--o", o);
    el.style.setProperty("--d", d + "s");
    el.style.setProperty("--dx", dx);
    el.style.setProperty("--r", r);

    worldFX.appendChild(el);
    setTimeout(()=>el.remove(), (d*1000)+250);
  }
  setInterval(()=>{ if(Math.random()<0.85) spawnWorldParticle(); }, 900);

  function renderWorldLanes(){
    if(worldAutoMini) worldAutoMini.textContent = `/: ${fmt(autoRate())}`;

    const bought = ITEMS
      .map(it => ({it, lvl:getOwned(it.id), mult:upgradeMult(it.id)}))
      .filter(x => x.lvl > 0);

    if(bought.length === 0){
      return;
    }

    const top = bought.slice().sort((a,b)=> (b.it.add*b.lvl*b.mult) - (a.it.add*a.lvl*a.mult))[0];
  }

  function renderCursorRing(){ }

  let buyMult = 1;
  let shopMode = "buy"; 

  function renderUpgrades(){
    if(!upgradeIcons) return;
    upgradeIcons.innerHTML = "";

    const avail = UPGRADES.filter(canShowUpgrade);
    avail.sort((a,b)=> (a.cost||0) - (b.cost||0));

    if(avail.length === 0){
      const ph = document.createElement("div");
      ph.className = "upPlaceholder";
      ph.textContent = "        (-  )";
      upgradeIcons.appendChild(ph);
      return;
    }

    for(const u of avail){
      const revealed = true;
      const d = document.createElement("div");
      d.dataset.upgradeId = u.id;
      const canBuy = canAfford(u.cost);
      d.className = "upIcon " + ("rarity-" + (u.rarity || (u.level===3?"legendary":u.level===2?"epic":"common"))) + (canBuy ? "" : " locked");
      d.textContent = revealed ? u.icon : "";

      d.addEventListener("mouseenter", (e)=>{
        const r = (u.rarity || (u.level===3?"legendary":u.level===2?"epic":"common"));
        const rLabel = (r==="legendary"?"":(r==="epic"?"":""));
        showTT(`<b>${u.name}</b> <span style="opacity:.75">(${rLabel})</span><br>${u.desc}<br><span style="opacity:.85">: <b>${fmt(u.cost)}</b> </span>`, e.clientX, e.clientY);
      });
      d.addEventListener("mousemove", (e)=>{ if(tt && tt.style.display==="block") showTT(tt.innerHTML, e.clientX, e.clientY); });
      d.addEventListener("mouseleave", hideTT);

      d.addEventListener("click", ()=>{
        if(!canAfford(u.cost)){ toast("   "); return; }
        if(buyUpgrade(u)){
          d.classList.add("bought");
          setTimeout(()=>d.remove(), 120);
          renderAll();
        }
      });

      upgradeIcons.appendChild(d);
    }
  }

  function updateShopAffordability(){
    if(!shopList) return;
    const love = state.love || 0;

    const rows = shopList.querySelectorAll(".shopRow");
    rows.forEach(row => {
      const id = row.dataset.id;
      if(!id) return;
      const item = ITEMS.find(x => x.id === id);
      if(!item) return;

      const owned = getOwned(id);
      const cost1 = unitPrice(item);

      if(love >= cost1){
        if(revealItem(id)) announceReveal(id);
      }
      const revealed = isRevealed(id) || love >= cost1;

      const priceN = totalPrice(item, buyMult);
      const canAct = (shopMode === "buy") ? (revealed && love >= priceN) : (owned > 0);

      row.classList.toggle("locked", !revealed);
      row.classList.toggle("disabled", revealed && !canAct);

      const icon = row.querySelector(".shopIcon");
      if(icon) icon.textContent = revealed ? item.icon : "";

      const nameEl = row.querySelector(".shopName");
      if(nameEl) nameEl.textContent = revealed ? item.name : "???";

      const costEl = row.querySelector(".shopCost");
      if(costEl){
        costEl.innerHTML = revealed
          ? `<span class="c"> x${buyMult}:</span> <b>${fmt(priceN)}</b> `
          : `<span class="c">:</span> <b>${fmt(cost1)}</b> `;
      }

      const lvl = row.querySelector(".shopRightLvl");
      if(lvl) lvl.textContent = owned;
    });

    const upIcons = document.querySelectorAll(".upIcon");
    upIcons.forEach(el => {
      const uid = el.dataset.upgradeId;
      if(!uid) return;
      const u = UPGRADES.find(x => x.id === uid);
      if(!u) return;
      const can = canAfford(u.cost) && canShowUpgrade(u);
      el.classList.toggle("locked", !can);
    });
  }

  function renderShop(){
    if(!shopList) return;
    shopList.innerHTML = "";

    for(const item of ITEMS){
      const owned = getOwned(item.id);
      const cost1 = unitPrice(item);

      if(state.love >= cost1){
        if(revealItem(item.id)) announceReveal(item.id);
      }
      const revealed = isRevealed(item.id) || state.love >= cost1;

      const priceN = totalPrice(item, buyMult);
      const canAct = (shopMode === "buy") ? (revealed && canAfford(priceN)) : (owned > 0);

      const row = document.createElement("div");
      row.dataset.id = item.id;
      row.className = "shopRow" + (revealed ? "" : " locked") + ((revealed && !canAct) ? " disabled" : "");

      const icon = document.createElement("div");
      icon.className = "shopIcon";
      icon.textContent = revealed ? item.icon : "";

      const main = document.createElement("div");
      main.className = "shopMain";

      const name = document.createElement("div");
      name.className = "shopName";
      name.textContent = revealed ? item.name : "???";

      const cost = document.createElement("div");
      cost.className = "shopCost";
      cost.innerHTML = revealed
        ? `<span class="c"> x${buyMult}:</span> <b>${fmt(priceN)}</b> `
        : `<span class="c">:</span> <b>${fmt(cost1)}</b> `;

      main.appendChild(name);
      main.appendChild(cost);
const lvl = document.createElement("div");
      lvl.className = "shopRightLvl";
      lvl.textContent = owned;

      row.appendChild(icon);
      row.appendChild(main);
      row.appendChild(lvl);

      row.addEventListener("mouseenter", (e)=>{
        const tName = revealed ? item.name : "???";

        const perLevelBase = revealed ? (item.add || 0) : 0;
        const upMult = revealed ? upgradeMult(item.id) : 1;
        const gMult = globalAutoMult();

        const perLevelReal = revealed ? perLevelBase * upMult * gMult : 0;
        const totalReal = revealed ? perLevelReal * owned : 0;

        const tDesc = revealed
          ? `${item.desc.split("+")[0]}+${fmt(perLevelReal)} /  .`
          : "  ,   .";

        const tRate = revealed
          ? ` : <b>+${fmt(totalReal)}</b> /`
          : "";

        showTT(
          `<b>${tName}</b><br>${tDesc}` +
          `${tRate ? "<br><span style='opacity:.85'>"+tRate+"</span>" : ""}`,
          e.clientX,
          e.clientY
        );
      });
row.addEventListener("mousemove", (e)=>{ if(tt && tt.style.display==="block") showTT(tt.innerHTML, e.clientX, e.clientY); });
      row.addEventListener("mouseleave", hideTT);

      row.addEventListener("click", ()=>{
        if(!revealed) return;

        if(shopMode === "buy"){
          if(!canAfford(priceN)){
            let lo=1, hi=buyMult, best=0;
            while(lo<=hi){
              const mid=(lo+hi)>>1;
              const costM = totalPrice(item, mid);
              if(canAfford(costM)){ best=mid; lo=mid+1; } else { hi=mid-1; }
            }
            if(best<=0){ toast("   "); return; }
            const costM = totalPrice(item, best);
            state.love -= costM;
            state.totalSpent = (state.totalSpent||0) + costM;
            state.totalPurchases = (state.totalPurchases||0) + 1;
            setOwned(item.id, owned + best);
            if(state.buffs && state.buffs.freePurchase){
              setOwned(item.id, getOwned(item.id) + 1);
              state.buffs.freePurchase = false;
              toastLong(`  : +1  "${item.name}"`);
            }
            checkAchievements();
            chatOnPurchase(item.id);
            if(state.buffs && (state.buffs.shopDiscountLeft||0) > 0){
              state.buffs.shopDiscountLeft = Math.max(0, Math.floor((state.buffs.shopDiscountLeft||0) - 1));
              if(state.buffs.shopDiscountLeft === 0){
                toastLong("  10% ");
              }else{
                toastLong(`  10%:   ${state.buffs.shopDiscountLeft}/10`);
              }
            }
            row.classList.add("bought");
            setTimeout(()=>row.classList.remove("bought"), 280);
            persist();
            renderAll(true);
            toast(` x${best}`);
            return;
          }
          state.love -= priceN;
          state.totalSpent = (state.totalSpent||0) + priceN;
          state.totalPurchases = (state.totalPurchases||0) + 1;
          setOwned(item.id, owned + buyMult);
            if(state.buffs && state.buffs.freePurchase){
              setOwned(item.id, getOwned(item.id) + 1);
              state.buffs.freePurchase = false;
              toastLong(`  : +1  "${item.name}"`);
            }
          checkAchievements();
          chatOnPurchase(item.id);
            if(state.buffs && (state.buffs.shopDiscountLeft||0) > 0){
              state.buffs.shopDiscountLeft = Math.max(0, Math.floor((state.buffs.shopDiscountLeft||0) - 1));
              if(state.buffs.shopDiscountLeft === 0){
                toastLong("  10% ");
              }else{
                toastLong(`  10%:   ${state.buffs.shopDiscountLeft}/10`);
              }
            }

          row.classList.add("bought");
          setTimeout(()=>row.classList.remove("bought"), 280);
          persist();
          renderAll(true);
        } else {
          if(owned <= 0){ toast(" "); return; }
          const sellCount = Math.min(buyMult, owned);

          const r = item.costMult, base=item.baseCost;
          const sumFor = (count) => count<=0 ? 0 : base * (Math.pow(r, count) - 1) / (r - 1);
          const totalC = sumFor(owned);
          const totalPrev = sumFor(owned - sellCount);
          const lastBlock = Math.floor(totalC - totalPrev);
          const refund = Math.floor(lastBlock * 0.5);

          setOwned(item.id, owned - sellCount);
          gainLove(refund);
          persist();
          toast(` x${sellCount} (+${fmt(refund)} )`);
          renderAll();
        }
      });

      shopList.appendChild(row);
    }
  }

  if(qtyTabs){
    qtyTabs.addEventListener("click", (e)=>{
      const b = e.target.closest("button[data-m]");
      if(!b) return;
      buyMult = Number(b.dataset.m || 1);
      [...qtyTabs.querySelectorAll("button")].forEach(x=>x.classList.toggle("active", x===b));
      renderShop();
    });
  }

  document.querySelectorAll(".modeTabs .tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".modeTabs .tab").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      shopMode = btn.dataset.mode;
      renderShop();
    });
  });
  
function popClickValue(x, y, val){
  const el = document.createElement("div");
  el.className = "clickPop";
  el.textContent = "+" + fmt(val);
  el.style.left = (x || window.innerWidth/2) + "px";
  el.style.top  = (y || window.innerHeight/2) + "px";
  document.body.appendChild(el);
  requestAnimationFrame(()=> el.classList.add("show"));
  setTimeout(()=>{ el.classList.remove("show"); el.style.opacity = "0"; }, 520);
  setTimeout(()=> el.remove(), 800);
}

function doClick(clientX, clientY){
    const add = perClick();
    popClickValue(clientX, clientY, add);
    gainLove(add);
    state.totalClicks = (state.totalClicks||0) + 1;
    forceMaybeTriggerQuiz();
    persist();
    checkAchievements();

    renderTop();
    renderShop();
    renderUpgrades();
  applyUpBarState();

    renderWorldLanes();
  }

  if(sideHeart){
    sideHeart.addEventListener("pointerdown", (e)=>{
      e.preventDefault();
      sideHeart.classList.add("pressed");
      sideHeart.classList.add("pulse");
      setTimeout(()=>sideHeart.classList.remove("pressed"), 90);
      setTimeout(()=>sideHeart.classList.remove("pulse"), 220);
      doClick(e.clientX, e.clientY);
    });
    sideHeart.addEventListener("click", (e)=>e.preventDefault());
  }

  let lastMsg = -1;
  function rotateMsg(){
    if(!worldMsg) return;
    let idx = Math.floor(Math.random()*MESSAGES.length);
    if(idx === lastMsg) idx = (idx+1) % MESSAGES.length;
    lastMsg = idx;
    worldMsg.textContent = MESSAGES[idx];
  }
  setInterval(rotateMsg, 4200);

  let cubeTimer = 0;
  function cubeBonusTick(){
    const cubes = getOwned("cube");
    if(cubes <= 0) return;
    if(Math.random() > 0.5) return;
    const base = baseAutoRate();
    if(base <= 0) return;
    const bonus = Math.floor(base * 30 * cubes);
    gainLove(bonus);
    toast(`Cube  : +${fmt(bonus)} `);
  }
  setInterval(cubeBonusTick, 10000);

  function applyOffline(){
    const now = Date.now();
    const last = Number(state.lastSeen || now);
    const deltaSec = Math.max(0, Math.min(3*60*60, (now - last)/1000));
    const rate = autoRate();
    if(deltaSec > 2 && rate > 0){
      const gain = Math.floor(rate * deltaSec);
      gainLove(gain);
      toast(`: +${fmt(gain)} `);
    }
    state.lastSeen = now;
    state._lastTickTs = now;
    state._autoFrac = 0;
    persist();
  }

  function tick(){
    const now = Date.now();
    const prev = state._lastTickTs || now;
    const dt = Math.max(0, Math.min(5, (now - prev)/1000));
    state._lastTickTs = now;

    state.playTimeMs = (state.playTimeMs || 0) + dt*1000;

    maybeStartEvents();
    const rate = autoRate();
    state._autoFrac = state._autoFrac || 0;
    const gainF = rate * dt + state._autoFrac;
    const gainI = Math.floor(gainF);
    state._autoFrac = gainF - gainI;
    gainLove(gainI);
    
    try{ updateShopAffordability(); }catch(e){}
state.best = Math.max(state.best, state.love);
    state.lastSeen = Date.now();
  }

  setInterval(()=>{
    tick();
    renderTop();
  }, 100);

  document.addEventListener("visibilitychange", ()=>{
    if(document.hidden){
      state.lastSeen = Date.now();
      persist();
    } else {
      applyOffline();
      renderAll();
    }
  });

  window.addEventListener("pagehide", ()=>{
    state.lastSeen = Date.now();
    persist();
  });

  setInterval(()=>persist(), 1200);

  function renderTop(){
    const love = Math.floor(state.love);
    const rate = autoRate();
    const type = activeType();
    const active = !!type;

    document.body.classList.toggle("fanmeet", type==="fanmeet");
    document.body.classList.toggle("cuberoulette", type==="cuberoulette");
const banner = document.getElementById("eventBanner");
    const titleEl = document.getElementById("eventTitle");
    const subEl = document.getElementById("eventSub");
    const timeEl = document.getElementById("eventTime");

    if(banner) banner.classList.toggle("hidden", !active);

    if(active){
      const left = Math.max(0, state.event.endsAt - Date.now());
      if(timeEl) timeEl.textContent = `(${Math.ceil(left/1000)})`;

      if(type==="fanmeet"){
        const v = (state.event && state.event.fanVariant) ? state.event.fanVariant : 1;
        if(titleEl) titleEl.textContent = "  ";
        let desc = "";
        if(v===1) desc = "13 :    777";
        else if(v===2) desc = "10 :  5%  ";
        else desc = `10 :    ${fanmeetV3Mult()} (i-dle)`;
        if(subEl) subEl.textContent = desc;
      }else if(type==="cuberoulette"){
        const mode = state.event.cubeMode;
        let desc = "";
        if(mode==="tiny")     desc = "10 :    15";
        if(mode==="long")     desc = "18 :    60";
        if(mode==="sprint")   desc = "12 :    120";
        if(mode==="ultra")    desc = "8 :    300";
        if(mode==="jackpot")  desc = `6 :  +${fmt(state.event.cubeBonus)}      450`;
        if(mode==="error")    desc = "15 : =0,     600";
        if(titleEl) titleEl.textContent = "Cube Roulette ";
        if(subEl) subEl.innerHTML = `${desc} <span class="eventTime" id="eventTime">${Math.ceil(left/1000)}</span>`;
      }
    }else{
      if(timeEl) timeEl.textContent = "";
    }

    const ico = document.querySelector("#sideHeart .ico");
    if(ico){
      ico.textContent = type==="fanmeet" ? "" : ((type==="cuberoulette" ? "" : ""));
    }
if(loveEl) loveEl.textContent = fmt(love);
    if(perClickEl) perClickEl.textContent = fmt(perClick());
    if(autoRateEl) autoRateEl.textContent = fmt(rate);
    if(bestEl) bestEl.textContent = fmt(Math.floor(state.best));

    if(loveBig) loveBig.textContent = fmt(love);
    if(autoBig) autoBig.textContent = "+" + fmt(rate) + " /";

    if(worldAutoMini) worldAutoMini.textContent = fmt(rate) + " /";
    if(worldBestMini) worldBestMini.textContent = ": " + fmt(Math.floor(state.best));
  }

  function renderAll(popNew=false){
    renderTop();
    renderUpgrades();
    renderShop();
    renderWorldLanes();
  }

  const CHAT_REACTIONS = {
    like: [
      {who:"neverland", text:" ! "},
      {who:"neverland", text:" ,  ! "},
      {who:"miyeon", text:"    ! "},
      {who:"miyeon", text:",   ! "},
    ],
    comment: [
      {who:"neverland", text:" ! "},
      {who:"neverland", text:"      "},
      {who:"miyeon", text:"   .  "},
      {who:"miyeon", text:"     "},
    ],
    minnie: [
      {who:"neverland", text:"  ! "},
      {who:"neverland", text:"   "},
      {who:"miyeon", text:"!!    "},
      {who:"miyeon", text:"  ? "},
    ],
    yuqi: [
      {who:"neverland", text:"   ! "},
      {who:"neverland", text:",    "},
      {who:"miyeon", text:"! "},
      {who:"miyeon", text:"     "},
    ],
    shuhua: [
      {who:"neverland", text:"  ! "},
      {who:"neverland", text:" ! "},
      {who:"miyeon", text:"!     "},
      {who:"miyeon", text:"  , ! "},
    ],
    soyeon: [
      {who:"neverland", text:"  ! "},
      {who:"neverland", text:"      "},
      {who:"miyeon", text:"   "},
      {who:"miyeon", text:"     "},
    ]};

  const CHAT_IDLE = [
    {who:"neverland", text:"Neverland   "},
    {who:"neverland", text:"        "},
    {who:"neverland", text:" ()    ? "},
    {who:"neverland", text:":       "},
    {who:"neverland", text:"      - "},
    {who:"neverland", text:"    ? "},
    {who:"neverland", text:" :   !"},
    {who:"neverland", text:"         "},
    {who:"neverland", text:"     "},
    {who:"neverland", text:"     "},
    {who:"miyeon", text:"( ) ... "},
    {who:"miyeon", text:"   , Neverland "},
    {who:"miyeon", text:"   ,  "},
    {who:"miyeon", text:",  ! "},
    {who:"miyeon", text:"   ? "},
    {who:"miyeon", text:" ,     "},
    {who:"miyeon", text:"     "},
    {who:"miyeon", text:":     "},
    {who:"miyeon", text:"    "},
    {who:"miyeon", text:"    ? "},
    {who:"miyeon", text:"      "},
    {who:"miyeon", text:"    "},
    {who:"miyeon", text:"     "},
    {who:"miyeon", text:" "},
    {who:"miyeon", text:""},
    {who:"miyeon", text:"  "},
    {who:"miyeon", text:"      "},
    {who:"miyeon", text:"  :     "},
    {who:"miyeon", text:"        ,    "},
    {who:"miyeon", text:", "},
    {who:"miyeon", text:"  ,     ,     "},
    {who:"miyeon", text:" "},
  ];

  let chatQueue = [];
  let chatHistory = [];
  let chatBusy = false;

  function chatRender(){
    if(!chatMsgs) return;
    const last = chatHistory.slice(-9);
    chatMsgs.innerHTML = "";

    for(const l of last){
      const wrap = document.createElement("div");
      wrap.className = "msg " + (l.who==="miyeon" ? "miyeon" : "neverland");

      const av = document.createElement("div");
      av.className = "avatar";
      av.textContent = (l.who==="miyeon") ? "MY" : "NL";

      const b = document.createElement("div");
      b.className = "bubble";
      const nm = (l.who==="miyeon") ? "" : "Neverland";
      b.innerHTML = `<div class="name">${nm}</div><div class="text">${l.text}</div>`;

      wrap.appendChild(av);
      wrap.appendChild(b);
      chatMsgs.appendChild(wrap);
    }
  }

  function chatTyping(on){
    if(!typingEl) return;
    typingEl.style.display = on ? "flex" : "none";
  }

  function chatPush(line){
    chatQueue.push(line);
    chatPump();
  }

  function chatPump(){
    if(chatBusy) return;
    if(chatQueue.length === 0) return;

    chatBusy = true;
    const line = chatQueue.shift();

    if(line.who === "miyeon"){
      chatTyping(true);
      setTimeout(()=>{
        chatTyping(false);
        chatHistory.push(line);
        chatRender();
        chatBusy = false;
        if(chatQueue.length) setTimeout(chatPump, 50);
      }, 500); 
    } else {
      chatHistory.push(line);
      chatRender();
      chatBusy = false;
      if(chatQueue.length) setTimeout(chatPump, 50);
    }
  }

  function chatSeed(){
    chatQueue = [];
    chatHistory = [
      {who:"neverland", text:",   ! "},
      {who:"miyeon", text:", Neverland    "},
    ];
    chatRender();
  }

  function chatIdleTick(){
    if(chatQueue.length) return;
    const lastText = chatHistory[chatHistory.length-1]?.text || "";
    let pick = CHAT_IDLE[Math.floor(Math.random()*CHAT_IDLE.length)];
    if(CHAT_IDLE.length>1){
      let guard=0;
      while(pick.text===lastText && guard<6){
        pick = CHAT_IDLE[Math.floor(Math.random()*CHAT_IDLE.length)];
        guard++;
      }
    }
    chatPush(pick);
  }

    function chatOnPurchase(itemId){
    const pack = CHAT_REACTIONS[itemId];
    if(!pack || pack.length === 0) return;
    const line = pack[Math.floor(Math.random()*pack.length)];
    chatPush(line);
  }

  window.resetProgress = function resetProgress(){
    const firstConfirm = confirm(" ,    ?\n   .");
    if(!firstConfirm) return;

    const secondConfirm = confirm(" !\n    .");
    if(!secondConfirm) return;

    try{ localStorage.removeItem(KEY); }catch(_){}

    state.love = 0;
    state.best = 0;
    state.owned = {};
    state.upgrades = {};
    state.revealedItems = {};
    state.boughtUpgrades = {};
    state.eventSeen = {};
    state.eventUpgrades = {};
    state.clicks = 0;
    state.totalClicks = 0;

    state.quiz = { idx: 0, nextAt: (QUIZ_THRESHOLDS[0]||40), used: {}, snoozeUntil: 0};
    state.quizActive = false;
    state._quizCurrent = null;

    state.quizStats = { started:0, answered:0, correct:0, streak:0, bestStreak:0, lastStartedIdx:-1, bonusPick:{ perm05:0, x300_10s:0, plus50pct:0, freebuy:0, discount10x:0 } };

    state.buffs = { clickMult: 1, clickMultUntil: 0, shopDiscountLeft: 0, freePurchase: false };
    state.totalPurchases = 0;
    state.playTimeMs = 0;
    state._lastTickTs = Date.now();
    state._autoFrac = 0;

    state.achievements = {};

    state.clickBase = 1;
    state.clickLevel = 0;
    state.clickCpsPct = 0;

    state.event = { type:null, endsAt:0, nextFanAt:0, nextCubeAt:0, cubeMode:null, cubeBonus:0, cubeClickMult:1, cubeAutoOff:false };
    state.lastSeen = Date.now();

    try{ persist(); }catch(_){}
    try{ render(); }catch(_){}

    location.reload();
  };

  load();
  applyOffline();
  rotateMsg();
  chatSeed();
  setInterval(chatIdleTick, 4200);
  renderAll();

function getClickValue(){
  return state.clickValue || 1;
}
function showClickFloat(val){
  const el = document.getElementById("clickFloat");
  if(!el) return;
  el.textContent = "+" + fmt(val);
  el.classList.remove("show");
  void el.offsetWidth;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"),600);
}

})();
</script></div>

  </body>
</html>
